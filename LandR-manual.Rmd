---
title: "LandR Manual"
subtitle: "v. 0.0.9000"
author: "Edited by: Ceres Barros, Alex M. Chubaty, Ian M. S. Eddy, Eliot J. B. McIntire"
date: "Last updated: `r Sys.Date()`"
site: bookdown::bookdown_site
bibliography:
  - citations/references_LandRManual.bib
csl: citations/ecology-letters.csl
link-citations: true
documentclass: book
github-repo: https://github.com/CeresBarros/LandR-Manual
description: "A manual for the LandR ecosystem of SpaDES modules"
cover-image: "figures/LandRHex.png"
editor_options: 
  chunk_output_type: console
---

<!-- manual version TODO: link to date and commit of manual/project repo -->

# Preface

```{r figLandRHex, eval = TRUE, echo = FALSE, fig.align = 'center', fig.dim = c(10,10)}
knitr::include_graphics(c("figures/LandRHex.png"))
```

LandR is a collection of `SpaDES` modules [see @ChubatyMcIntire2019] which are aimed at simulating forest dynamics across large spatial scales, while taking into account various disturbances that affected them (e.g., wildfire and climate change), as well as their interactions with other components of forest systems, such as bird communities and ungulates (via changes in the habitat of these species) or carbon cycling.

The present manual is a "live" document, in that will grow and change according to the existing number of LandR modules, as well as their development. In addition, sub-manuals may be produced describing smaller collections of LandR modules -- e.g., the LandR Biomass manual describes only the LandR modules that are essential for the simulation of the vegetation components of forest succession, hence excluding fire disturbance modules.

<!--chapter:end:index.Rmd-->


# LandR *Biomass_core* Module

<!-- the following are text references used in captions for LaTeX compatibility -->

(ref:Biomass-core) *Biomass_core*

```{r setup-Biomass-core, include=FALSE, eval = TRUE}
knitr::opts_knit$set(root.dir = "modules/Biomass_core")
## set cache.rebuild = TRUE whenever there are changes to the module code/metadata
knitr::opts_chunk$set(echo = TRUE, eval = FALSE, warning = FALSE, 
                      cache = 2, cache.rebuild = FALSE, results = "hold", dpi = 300)

## get citation style
if (!file.exists("citations/ecology-letters.csl")) {
  Require::checkPath("citations", create = TRUE)
  download.file("https://www.zotero.org/styles/ecology-letters", destfile = "citations/ecology-letters.csl")
}

Require(c("dplyr", "kableExtra"))
```

[![made-with-Markdown](https://img.shields.io/badge/Made%20with-Markdown-1f425f.png)](http://commonmark.org)
[![Generic badge](https://img.shields.io/badge/Get%20help-Report%20issues-%3CCOLOR%3E.png)](https://github.com/PredictiveEcology/Biomass_core/issues)

<!-- if knitting to pdf remember to add the pandoc_args: ["--extract-media", "."] option to yml in order to get the badge images -->

**This documentation is work in progress. Potential discrepancies and omissions may exist for the time being. If you find any, do contact us using the link above\^\^**

#### Authors:

`r paste(as.character(SpaDES.core::moduleMetadata(module = 'Biomass_core', path = '..')$authors), sep = ', ')` <!-- ideally separate authors with new lines, '\n' not working -->

## Module Overview

### Module summary

LandR *Biomass_core* (hereafter *Biomass_core*) is the core forest succession simulation module of the LandR ecosystem of `SpaDES` modules [see @ChubatyMcIntire2019]. It simulates tree cohort ageing, growth, mortality and competition for light resources, as well as seed dispersal (Fig. \@ref(fig:fig-Biomass-core)), in a spatially explicit manner and using a yearly time steps. The model is based on the LANDIS-II Biomass Succession Extension v.3.2.1 [LBSE; @SchellerMiranda2015], with a few changes (see [Differences between *Biomass_core* and LBSE]). Nonetheless, the essential functioning of the succession model still largely follows its LANDIS-II counterpart, and we refer the reader to the corresponding LANDIS-II BSE manual [@SchellerMiranda2015] for a detailed reading of the mechanisms implemented in the model.

```{r fig-Biomass-core, echo = FALSE, eval = TRUE, out.width = "60%", fig.align = 'center', fig.cap = "(ref:Biomass-core) simulates tree cohort growth, mortality, recruitment and dispersal dynamics, as a function of  cohort ageing and competition for light (shading) and space, as well as disturbances like fire (simulated using other modules)."}
knitr::include_graphics("figures/Biomass_coreSchematic.png")
```

### Module inputs and parameters

*Biomass_core* is capable of running on dummy datasets from which it estimates parameters linked to vegetation growth and seed germination (such as the maximum biomass per species, per pixel, and the probability of seed germination -- *i.e.*, species establishment probability not due to resprouting), but also builds and initializes forest communities (based on biomass, age, species composition, land cover and ecological zones like ecodistricts.

Ideally, however, the user should supply realistic versions of these data and the essential initialization objects that *Biomass_core* requires to run.

Table \@ref(tab:moduleInputs-Biomass-core) shows a full list of input objects that *Biomass_core* expects. Of these, the only input that **must** be provided (*i.e.*, *Biomass_core* does not have a default for) is `studyArea`. All other input objects and parameters have internal defaults (see Tables \@ref(tab:moduleInputs2-Biomass-core) and \@ref(tab:moduleParams2-Biomass-core).

```{r moduleInputs-Biomass-core, echo = FALSE, eval = TRUE, message = FALSE}
df_inputs <- SpaDES.core::moduleInputs("Biomass_core", "..")[, c(1, 3)]  ## name + desc only
knitr::kable(df_inputs,
             caption = "List of (ref:Biomass-core) input objects and their description.") %>%
  kableExtra::kable_styling(latex_options = "scale_down", full_width = TRUE)
```

Of the above, we draw particular attention to the the following inputs, which are crucial to run *Biomass_core* on a realistic setting (see [Input objects] section of the manual for further detail):

-   Spatial layers: `ecoregionMap`, `studyArea`

-   Trait and parameter tables: `ecoregion`, `minRelativeB`, `species`, `speciesEcoregion`, `sufficientLight`, `sppEquiv`, `sppColorVect`

-   Cohort-simulation related: `cohortData`, `pixelGroupMap`

For the beginner user, we suggest running *Biomass_core* without supplying any inputs and inspecting the above mentioned objects to understand their structure and format. The user can later either feed these objects via `simInit`, or make a module that makes them and provides necessary inputs to *Biomass_core* (see e.g. [*Biomass_borealDataPrep*](https://github.com/PredictiveEcology/Biomass_borealDataPrep))

Besides the above mentioned inputs, *Biomass_core* uses several other parameters, which can be changed by the user if need be (Table \@ref(tab:moduleParams-Biomass-core)). Please see the [Parameters] section of the manual for a list of the most useful parameters.

```{r moduleParams-Biomass-core, echo = FALSE, eval = TRUE, message = FALSE}
df_params <- SpaDES.core::moduleParams("Biomass_core", "..")[, c(1, 6)] ## name + desc only
knitr::kable(df_params,
             caption = "List of (ref:Biomass-core) parameters and their description.") %>%
  kableExtra::kable_styling(latex_options = "scale_down", full_width = TRUE)
```

### Events

Events are scheduled as follows:

-   Module initiation (`init` event)
-   Seed dispersal (every `successionTimestep`; `Dispersal` event)
-   Mortality and growth (`mortalityAndGrowth` event)
-   Reclassification of age cohorts (every `successionTimestep`; `cohortAgeReclassification` event)
-   Summary tables of regeneration (`summaryRegen` event), biomass, age, growth and mortality (`summaryBGM\*` event)
-   Plots of maps (`plotMaps` event) and averages (`plotAvgs` and `plotSummaryBySpecies` events)
-   Save (`save`)

### Module outputs

The module produces the following outputs types. -- Plotting -- live and/or saved plot objects/images (depending on `.plots`)

-- Saved biomass, mortality, leading vegetation raster layers -- Whatever objects supplied to `outputs` argument in `simInit`, that are within the `simList` object.

All `simList` objects that are changed by *Biomass_core* (*i.e.*, the definition of a module output) are listed in Table \@ref(tab:moduleOutputs-Biomass-core).

```{r moduleOutputs-Biomass-core, echo = FALSE, eval = TRUE, message = FALSE}
df_outputs <- SpaDES.core::moduleOutputs("Biomass_core", "..")[, c(1, 3)] ## name + desc only
knitr::kable(df_outputs,
             caption = "List of (ref:Biomass-core) output objects and their description.") %>%
  kableExtra::kable_styling(latex_options = "scale_down", full_width = TRUE)
```

### Links to other modules

Intended to be used with other landscape modules, such as *LandMine*, *fireSense*, *Biomass_borealDataPrep*, *Biomass_regeneration* and possibly many others. You can see all *potential* module linkages within the LandR ecosystem [here](https://rpubs.com/PredictiveEcology/LandR_Module_Ecosystem). Select *Biomass_core* from the drop-down menu to see linkages.

### Getting help

-   <https://github.com/PredictiveEcology/Biomass_core/issues>

## Module manual

### Introduction

LandR *Biomass_core* (hereafter *Biomass_core*) a forest landscape model based on the LANDIS-II Biomass Succession Extension v.3.2.1 model [LBSE; @SchellerMiranda2015]. It is the core forest succession model of the LandR ecosystem of `SpaDES` modules. Similarly to the LBSE, *Biomass_core* simulates changes in tree cohort aboveground biomass (g/m^2^.) by calculating growth, mortality and recruitment as functions of pixel and species characteristics, competition and disturbances (Fig. \@ref(fig:fig-Biomass-core)). Specifically, growth is driven by both invariant (`growthcurve`) and spatially varying species growth traits (maximum biomass, `maxB`, and maximum annual net primary productivity, `maxANPP`), while mortality depends only on invariant species traits (`age`, `longevity` and `mortalityshape`). Disturbances (e.g., fire) can also cause cohort mortality, but are simulated in separate modules (e.g., *Biomass_regeneration* simulates the death of all cohorts immediately after a fire). The parameters `growthcurve` and `mortalityshape` directly influence the shape of species growth curves, by determining how fast they grow and how soon age mortality starts with respect to longevity. Cohort recruitment is determined by available "space" (*i.e.*, pixel shade), invariant species traits (regeneration mode, age at maturity, shade tolerance) and spatially varying traits (species establishment probability, `SEP`). The available "growing space" is calculated as species `maxB` minus the occupied biomass (summed across other cohorts and species). If there is "space", a cohort can establish from one of three recruitment modes: serotiny, resprouting and germinating. Serotiny and resprouting occur only in response to fire and are simulated in two separate, but interchangeable modules, *Biomass_regeneration* and *Biomass_regenerationPM*. Germination occurs if seeds are made available from local sources (the pixel), or via seed dispersal. Seed dispersal can be of three modes: 'no dispersal', 'universal dispersal' (only interesting for dummy case studies) or 'ward dispersal' [@SchellerMiranda2015]. The 'ward dispersal' algorithm describes a flexible kernel that calculates the probability of a species colonising a neighbour pixel as a function of distance from the source and dispersal-related (and invariant) species traits, and is used by default. We refer the reader to @SchellerMiranda2015, @SchellerDomingo2011 and @SchellerDomingo2012 for further details with respect to the mechanisms implemented in the module.

### Differences between *Biomass_core* and LBSE

#### Algorithm changes

Upon porting LBSE into R, we made six minor modifications to the original model's algorithms to better reflect ecological processes. This did not result in dramatic changes in simulation outputs and we note that these changes might also have been implemented in more recent versions of LBSE.

First, for each year and community (*i.e.*, 'pixel group' in *Biomass_core*, see below), LBSE calculates the competition index for a cohort sequentially (*i.e.*, one cohort at a time) after updating the growth and mortality (*i.e.*, the biomass gain and loss, respectively) of other cohorts, and with the calculation sequence following cohort age in descending order, but no explicit order of species. This sorting of growth and mortality calculations from oldest to youngest cohorts in LBSE was aimed at capturing size-asymmetric competition between cohorts, under the assumption that older cohorts have priority for growing space given their greater height (Scheller pers. comm.). We felt that sequential, within-year growth, death and recruitment may be not ecologically accurate, and that the size-asymmetric competition was being accounted for twice, as the calculation of the competition index already considers the competitive advantage of older cohorts [as shown in the User's Guide; @SchellerMiranda2015]. Hence, in *Biomass_core* growth, mortality and the competition index are calculated at the same time across all cohorts and species.

Second, the unknown species-level sorting mechanism contained within LBSE (which changed depending on the species order in the input species list file), led to different simulation results depending on the input species list file (e.g., Table \@ref(tab:tableLBSEtest1) and Fig. \@ref(fig:figLBSEtest1)). The calculation of competition, growth and mortality for all cohorts at the same time also circumvented this issue.

Third, in LBSE the calculation of total pixel biomass for the purpose of calculating the initial biomass of a new cohort included the (previously calculated) biomass of other new cohorts when succession time step = 1, but not when time step was \> 1. This does not reflect the documentation in the User's Guide, which stated that "Bsum [total pixel biomass] is the current total biomass for the site (not including other new cohorts)" [@SchellerMiranda2015, pp. 4], when the succession time step was set to 1. Additionally, together with the lack of explicit ordering, it generated different results in terms of the biomass assigned to each new cohort (e.g. Table \@ref(tab:tableLBSEtest2) and Fig. \@ref(fig:figLBSEtest2)). In *Biomass_core* the initial biomass of new cohorts is no longer calculated sequentially (as with competition, growth and mortality), and thus the biomass of new cohorts is never included in the calculation of total pixel biomass.

Fourth, in LBSE, serotiny and resprouting could not occur in the same pixel following a fire, with serotiny taking precedence if activated. We understand that this provides an advantage to serotinous species, which could perhaps be disadvantaged with respect to fast-growing resprouters. However, we feel that it is ecologically more realistic that serotinous and resprouter species be able to both regenerate in a given community following a fire and allow the competition between serotinous and resprouting species to arise from species traits. **Note that this change was implemented in the *Biomass_regeneration* and *Biomass_regenerationPM* modules.**

Fifth, in *Biomass_core*, species shade tolerance values can have decimal values to allow for finer adjustments of between-species competition.

Sixth, we added a new parameter called `minCohortBiomass`, that allows the user to control cohort removal bellow a certain threshold of biomass. In some simulation set-ups, we noticed that *Biomass_core* (and LBSE) were able to generate many very small cohorts in the understory that, due to cohort competition, were not able to gain biomass and grow. However, because competition does not increase mortality, only decreases growth, these cohorts survived at very low biomass levels until they reached sufficient age to suffer age-related mortality. We felt this is unlikely to be realistic in many cases. By default, this parameter is left at 0 to follow LBSE behaviour (*i.e.*, no cohorts removal based on minimum biomass).

#### Other enhancements

In addition to the five minor changes in growth, mortality and regeneration, we separated the components that govern vegetation responses to disturbances -- only fire at the moment -- into two independent modules, used interchangeably, and implemented hashing, caching and testing to improve the model's computational efficiency and insure its performance.

##### Modularity

Unlike in LBSE, post-disturbance regeneration is not part of *Biomass_core* *per se*, but belongs to two separate modules, used interchangeably ([*Biomass_regeneration*](https://github.com/PredictiveEcology/Biomass_regeneration/blob/master/Biomass_regeneration.Rmd) and [*Biomass_regenerationPM*](https://github.com/PredictiveEcology/Biomass_regenerationPM/blob/master/Biomass_regenerationPM.Rmd)). These need to be loaded and added to the "modules folder" of the project in case the user wants to simulate forest responses to disturbances (only fire disturbances at the moment). Again, this enables higher flexibility when swapping between different approaches to regeneration. For instance, default (*i.e.*, not climate sensitive) growth and mortality functions are part of the `LandR` R package, which needs to be loaded prior to running *Biomass_core*. Should the user wish to change the growth/mortality algorithms, they would need to provide compatible functions (with the same names) to the simulation via `simInit` -- user-provided functions will replace those loaded with a package <!-- we should have an example of this-->. Note that the `LandR` package provides other supporting functions and objects to the simulation, and still needs to be loaded prior to running *Biomass_core*.

##### Hashing

Our first strategy to improve simulation efficiency in *Biomass_core* was to use a hashing mechanism [@YangEtAl2011]. Instead of assigning a key to each pixel in a raster and tracking the simulation for each pixel in a lookup table, we indexed pixels using a *pixelGroup* key that contained unique combinations of ecolocation and community, and tracked and stored simulation data for each *pixelGroup* (Fig. \@ref(fig:figLBSEtest3)). Ecolocation (called 'ecoregion' in LBSE and in model objects) is a spatial unit with similar biophysical characteristics. In our applications, we define ecolocation as the combination of land-cover types from the Land Cover Map of Canada 2005 (v1) and ecodistricts from the National Ecological Framework for Canada (<!--add source-->). Hence, these ecolocations contain relatively fine scale land cover information plus coarse scale regional information. In turn, community is the species composition and age structure of a particular pixel. This algorithm was able to ease the computational burden by significantly reducing the size of the lookup table and speeding-up the simulation process. After recruitment and disturbance events, pixels are rehashed into new pixel groups.

##### Caching

The second strategy aimed at improving model efficacy was the implementation of caching, and data-driven parametrisation and initialisation. Caching automatically archives outputs of a given function to disk (or memory) and reads them back when subsequent calls of this function are given identical inputs. All caching operations were achieved using the `reproducible` R package [@McIntireChubaty2020]. In the current version of *Biomass_core*, the spin-up phase was replaced by data-driven landscape initialisation and many model parameters were derived from data, using "data modules" (e.g., *Biomass_borealDataPrep*). To avoid having to repeat data downloads and treatment, statistical estimation of parameters and landscape initialisation every time the simulation is re-run under the same conditions (*i.e.*, no data or algorithm changes), many of these pre-simulation steps are automatically cached. This means that the pre-simulation phase is significantly faster upon a second call when inputs have not changed (e.g., the input data and parametrisation methods), and when inputs do change only directly affected steps are re-run (see main text for examples). When not using data modules, *Biomass_core* still relies on caching for the preparation of its theoretical inputs.

##### Testing

Finally, we implemented code testing, to facilitate bug detection by comparing the outputs of functions [etc.] to expected outputs [@Wickham2011]. We built and integrated code tests in *Biomass_core* and across all LandR modules and the `LandR` R package <!-- package name may change --> and the in the form of assertions and integration tests. Assertions are run automatically during simulations (but can be turned off), while integration are be run manually. Tests were also implemented in R package dependencies of *Biomass_core*, such as the `LandR` R package <!-- package name may change --> and `SpaDES`, which are routinely tested using GitHub Actions continuous integration (CI) or automated checks on CRAN. For the `LandR` R package, we use GitHub Actions CI to automatically test for installation and execution errors.

Finally, because *Biomass_core* (and all other LandR modules) code is hosted in public GitHub repositories, there is a potentially high number of users that can identify issues and contribute to improve module code.

#### Performance and accuracy of *Biomass_core* with respect to LBSE {data-link="Algorithm changes"}

In the recoding of *Biomass_core*, we ensured similar outputs of each demographic process (namely, growth, mortality and recruitment) to the outputs from its counterpart in LBSE, using integration tests. Here, we report the comparisons of the overall simulation (i.e., including all demographic processes) between LBSE and *Biomass_core* using three randomly generated initial communities (Tables \@ref(tab:tableLBSEtest3)-\@ref(tab:tableLBSEtest5)). The remaining input parameters were taken from a LANDIS-II training course (Tables \@ref(tab:tableLBSEtest6)-\@ref(tab:tableLBSEtest9)), and contained species attributes information of 16 common tree species in boreal forests and 2 ecolocations. We ran simulations for 1000 years, with a succession time step of 10 and three repetitions, which were enough to account for the variability produced by stochastic processes. Seed dispersal was set as "ward dispersal".

The results suggested that *Biomass_core* had a good agreement with LBSE using the three randomly generated initial communities (Fig. \@ref(fig:figLBSEtest4)), with very small deviations for LBSE-generated biomasses. Notably, the mean differences between LBSE and *Biomass_core* were 0.03% (range: -0.01% \~ 0.13%), 0.03% (range: -0.01% \~ 0.11%) and 0.05% (-0.02% \~ 0.15%) for each initial community, respectively (right panels in Fig. \@ref(fig:figLBSEtest4) of this appendix).

To examine how running time changed with map size, we ran simulations using maps with increasing number of pixels from 22,201 to 638,401. All maps were initialised with a single ecolocation and 7 different communities. Simulations were run for 120 years using a succession time step of 10 and replicated three times. To eliminate the effect of hardware on running time, we used machines that were all purchased at the same time, with equal specifications and running Windows 7. Each simulation ran on 2 CPU threads with a total RAM of 4000 Mb. For both LBSE and *Biomass_core*, the simulation time increased linearly with number of pixels, but the increase rate was smaller for *Biomass_core* (Fig. \@ref(fig:figLBSEtest5)a). This meant that while both models had similar simulation efficiencies in small maps (\< 90,000 pixels), as map size increased *Biomass_core* was \~2 times faster than LBSE (maps \> 100,000 pixels; Fig. \@ref(fig:figLBSEtest5)a). *Biomass_core* also scaled better with map size, as LBSE speeds fluctuated between 19 to 25 seconds per 1,000 pixels across all map sizes, while *Biomass_core* decreased from 21 to 11 seconds per 1,000 pixels from smaller to larger maps (Fig. \@ref(fig:figLBSEtest5)b).

### Initialization, inputs and parameters

Unlike the initialization in LBSE, which "iterates the number of time steps equal to the maximum cohort age for each site", beginning at *t* -- oldest cohort age and adding cohorts at the appropriate time [@SchellerMiranda2015], *Biomass_core* initializes the simulation by deriving initial biomasses from available data, using data modules. If data modules are not available, *Biomass_core* initializes itself with theoretical data.

To be initialized, *Biomass_core* requires the following input objects and parameters:

#### Input objects

All of *Biomass_core*'s input objects have (theoretical) defaults that are produced automatically by the module (when running the `.inputObjects` function during the `simInit` call, and in the `init` event during the `spades` call -- see `?SpaDES.core::events` and `SpaDES.core::simInit`). We suggest that new users run *Biomass_core* by itself supplying only a `studyArea` object. This will enable them to become familiar with all the input objects before attempting to supply their own, or combine *Biomass_core* with data modules.

```{r moduleInputs2-Biomass-core, echo = FALSE, eval = TRUE, message = FALSE}
df_inputs <- SpaDES.core::moduleInputs("Biomass_core", "..")
knitr::kable(df_inputs, 
             caption = "List of (ref:Biomass-core) input objects and their description.") %>%
  kableExtra::kable_styling(latex_options = "scale_down", full_width = TRUE)
```

Of the inputs in Table \@ref(tab:moduleInputs2-Biomass-core), the following are particularly important and deserve special attention:

-   **Spatial layers**

    -   `ecoregionMap` -- a raster layer with ecolocation IDs (note that the term "ecoregion" was inherited from LBSE and kept as is for consistency with original LBSE code). Ecolocations group pixels or similar biophysical conditions using up to two levels of grouping. In many of our applications, we use the Natural Ecoregion classification of Canada as the first grouping level and a land-cover classification as the second level. The raster layer must be defined as a categorical variable, with an associated Raster Attribute Table (RAT; see, e.g., `raster::ratify`). The RAT must contain the columns: `ID` (the value in the raster layer), `ecoregion` (the first level of ecolocation grouping) and `ecoregionGroup` (the full ecolocation "name" written as \<firstlevel_secondlevel>). Note that `ecoregionGroup` usually originated from combining two raster layers and, thus, the grouping level IDs are also integers. For instance, if Natural Ecoregion `2` has land-cover types `1`, `2` and `3`, the RAT will contain `ID = {1,2,3}`, `ecoregion = {2}` and `ecoregionGroup = {2_1, 2_2, 2_3}`. All ecolocations are listed in the `ecoregion` `data.table`.

    -   `rasterToMatch` -- a RasterLayer, with a given resolution and projection determining the pixels (*i.e.*, non NA values) where forest dynamics will be simulated. Needs to match `studyArea`. If not supplied, *Biomass_core* attempts to produce it, using `biomassMap` as the template for spatial resolution and projection.

    -   `studyArea` -- shapefile. A `SpatialPolygonsDataFrame` with a single polygon determing the where the simulation will take place. This is the only input object that **must be supplied by the user**.

-   **Species traits and other parameter tables**

    -   `ecoregion` -- `data.table` listing all ecolocation "names" (*ecoregionGroup* column; see `ecoregionMap` above for details) and their state (active -- `yes` -- or inactive -- `no`)

    -   `minRelativeB` -- `data.table` of minimum relative biomass values. This is a spatially variant trait used to determine the shade level in each pixel [see @SchellerMiranda2015, pp. 14], yet in our applications we often keep values constant across ecolocations. The table must contain the following columns:

        -   *ecoregionGroup --* character. Ecolocation names. See `ecoregionMap` and `ecoregion` objects above.

        -   *X0-X5* -- six numeric columns, one per shade class (no-shade, 0, to maximum shade, 5), with 0 to 1 values determining the minimum threshold of biomass (relative to the species/ecolocation `maxB`) necessary to reach a given shade-level. This means that shade-levels are determined on a species by species basis [see @SchellerMiranda2015, pp. 14]

    -   `species` -- `data.table` of *invariant species traits*. There are species traits that do no vary spatially, nor temporally (e.g., longevity). The table must contain the following trait values (*i.e.*, columns) in order to run *Biomass_core* (note that columns should follow the data type indicated):

        -   *speciesCode --* character. Species ID.

        -   *longevity --* integer. Maximum age in years [see @SchellerDomingo2011, pp. 18].

        -   *sexualmature --* integer. Age at sexual maturity in years [see @SchellerDomingo2011, pp. 18].

        -   *shadetolerance --* integer OR numeric. *Relative* shade tolerance (see [Algorithm changes]).

        -   *seeddistance_eff --* integer. Eeffective seed distance in meters. [see @SchellerDomingo2011, pp. 18]

        -   *seeddistance_max --* integer. Maximum seed distance in meters. Note that is the pixel size is larger than the maximum seed distance, the species will not be able to disperse to neighbouring pixels [see @SchellerDomingo2011, pp. 18].

        -   *mortalityshape --* integer. Shape of growth curve determining how quickly mortality begins [see @SchellerMiranda2015, pp. 15].

        -   *growthcurve --* numeric. Shape of growth curve determining ANPP reaches its maximum [see @SchellerMiranda2015, pp. 16].

    -   `speciesEcoregion` -- `data.table` of *spatiotemporally-varying species traits*. There are species traits vary spatially and, potentially, temporally. The table must contain the following columns in order to run *Biomass_core*:

        -   *ecoregionGroup* -- character. Ecolocation names. See `ecoregionMap` and `ecoregion` objects above.

        -   *speciesCode* -- character. Species ID.

        -   *establishprob* -- numeric. Species establishment probability (`SEP`) for a given species in an ecolocation and, potentially year. SEP influences the success of incoming seed germination, given pixel biophysical characteristics (note that *actual* success is determined by both SEP and light conditions in the pixel) [see @SchellerMiranda2015, pp. 18].

        -   *maxB* -- integer. Maximum biomass for a given species in an ecolocation in units of g biomass / m^2^. Note that the actual maximum biomass reached by a species in a pixel may exceed `maxB` because `maxB` is applied at the cohort level an species may have several cohorts in a given pixel [see @SchellerMiranda2015, pp. 18].

        -   *maxANPP* -- numeric. Maximum aboveground net primary productivity in units of g biomass / m^2^ / year, by default it is calculated as 1/30 of `maxB` [see @SchellerMiranda2015, pp. 18]

        -   *year* -- integer. Used when varying `SEP`, `maxB` and `maxANPP` values in time. Otherwise, use fill all lines with `0`.

    -   `sufficientLight` -- `data.table` defining the probability of germination for a species, given its `shadetolerance` level (see `species` above) and the shade level in the pixel (see `minRelativeB` above). Must contain columns:

        -   *speciesshadetolerance* -- integer. Species shade tolerance levels, from 1-5 (all levels must be present in this table).

        -   *X0-X5* -- six integer columns, one per shade class (no-shade, 0, to maximum shade, 5), filled with 0s OR 1s values determining the probability of germination (or resprouting) for a species given a shade-level[see @SchellerMiranda2015, pp. 14]. Unlike LBSE, species `shadetolerance` values can take decimal values between 1-5, in which case the resulting probability of germination in a given pixel is interpolated between the corresponding lower and upper shade tolerance values.

    -   `sppEquiv` -- a `data.table` of species name equivalencies between various conventions. It must contain the columns *LandR* (species IDs following in LandR format) *EN_generic_short* (short generic species names in English -- or any other language; used for plotting), *Type* (type of species, *Conifer* or *Deciduous*, as in "broadleaf") and *Leading* (same as *EN_generic_short* but with "leading" appended -- e.g., "Poplar leading") <!-- we should add an assertion that checks whether these columns are present early on!!! -->. See `?LandR::sppEquivalencies_CA` for more information.

    -   `sppColorVect` -- character. A named vector of colours used to plot species dynamics. Should contain one colour per species in the `species` table and, potentially a colour for species mixtures (named "Mixed"). Vector names must follow `species$speciesCode`.

-   **Cohort-simulation-related objects**

    -   `cohortData` -- a `data.table` containing initial cohort information per *pixelGroup* (see `pixelGroupMap` below). This table is updated during the simulation as cohort dynamics are simulated. Must contain the following columns

        -   *pixelGroup* -- integer. *pixelGroup* ID. See [Hashing].

        -   *ecoregionGroup* -- character. Ecolocation names. See `ecoregionMap` and `ecoregion` objects above.

        -   *speciesCode* -- character. Species ID.

        -   *age* -- integer. Cohort age.

        -   *B* -- integer. cohort biomass in g/m^2^.

        -   *mortality* -- integer. cohort dead biomass in the current year in g/m^2^. Should be filled with 0s in initial conditions.

        -   *aNPPAct* -- integer. Actual aboveground net primary productivity of the current year in g/m^2^. Hence *B* is the result of the previous year's *B* minus *mortality* plus *aNPPAct*. See "1.1.3 Cohort growth and ageing" section of @SchellerMiranda2015.

    -   `pixelGroupMap` -- a raster layer with *pixelGroup* IDs per pixel. Pixels are always grouped based on identical *ecoregionGroup*, *speciesCode*, *age* and *B* composition, even if the user supplies other initial groupings (e.g., this is possible in the *Biomass_borealDataPrep* data module).

#### Parameters

Table \@ref(tab:moduleParams2-Biomass-core) lists all parameters used in *Biomass_core*. Note that a few of these parameters are only relevant when simulating climate effects of cohort growth and mortality, which require also loading the `LandR.CS` R package. Like with input objects, default values are supplied for all parameters and we suggest the user becomes familiarized with them before attempting any changes. We also note that the `"spin-up"` and `"biomassMap"` options for the `initialBiomassSource` are currently deactivated, since *Biomass_core* no longer generates initial cohort biomass conditions using a spin-up based on initial stand age like LANDIS-II (`"spin-up"`), nor does it attempt to fill initial cohort biomasses using `biomassMap` (`"biomassMap"`). A list of useful parameters and their description is shown in Table \@ref(tab:tableUsefulParams).

```{r moduleParams2-Biomass-core, echo = FALSE, eval = TRUE, message = FALSE}
df_params <- SpaDES.core::moduleParams("Biomass_core", "..")
knitr::kable(df_params,
             caption = "List of (ref:Biomass-core) parameters and their description.") %>%
  kableExtra::kable_styling(latex_options = "scale_down", full_width = TRUE)
```

::: fullwidth
+------------------------+-------------------------------------------------------------------------------------------------+
| Required inputs        | Description                                                                                     |
+:=======================+:================================================================================================+
| Plotting & saving      |                                                                                                 |
+------------------------+-------------------------------------------------------------------------------------------------+
| `.plots`               | activates/deactivates plotting and defines type fo plotting (see `?Plots`)                      |
+------------------------+-------------------------------------------------------------------------------------------------+
| `.plotInitialTime`     | defines when plotting starts                                                                    |
+------------------------+-------------------------------------------------------------------------------------------------+
| `.plotInterval`        | defines plotting frequency                                                                      |
+------------------------+-------------------------------------------------------------------------------------------------+
| `.plotMaps`            | activates/deactivates map plotting                                                              |
+------------------------+-------------------------------------------------------------------------------------------------+
| `.saveInitialTime`     | defines when saving starts                                                                      |
+------------------------+-------------------------------------------------------------------------------------------------+
| `.saveInterval`        | defines saving frequency                                                                        |
+------------------------+-------------------------------------------------------------------------------------------------+
| Simulation             |                                                                                                 |
+------------------------+-------------------------------------------------------------------------------------------------+
| `seedingAlgorithm`     | dispersal type (see above)                                                                      |
+------------------------+-------------------------------------------------------------------------------------------------+
| `successionTimestep`   | defines frequency of dispersal/local recruitment event (growth and mortality are always yearly) |
+------------------------+-------------------------------------------------------------------------------------------------+
| Other                  |                                                                                                 |
+------------------------+-------------------------------------------------------------------------------------------------+
| `mixedType`            | how mixed forest stands are defined                                                             |
+------------------------+-------------------------------------------------------------------------------------------------+
| `vegLeadingProportion` | relative biomass threshold to consider a species "leading" (*i.e.*, dominant)                   |
+------------------------+-------------------------------------------------------------------------------------------------+
:::

: (#tab:tableUsefulParams) Useful *Biomass_core* parameters.

### Simulation flow

#### No disturbances

*Biomass_core* itself does not simulate disturbances, or their effect on vegetation (*i.e.*, post-disturbance mortality and regeneration). The general flow of *Biomass_core* processes is:

1.  Preparation of necessary objects for the simulation -- either by accessory data prep. modules, or *Biomass_core* itself (using LANDIS-II test parameters and dummy data for stand age, biomass and land cover and ecological zoning)
2.  Seed dispersal -- see @SchellerDomingo2012 for details

-   Seed dispersal can be a slow process and has been adapted to occur every 10 years. The user can set it to occur more often, but this should not make much of a difference to model outputs, because age classes are meant to be collapsed to tens.

3.  Growth and mortality -- based on @SchellerMladenoff2004

-   unlike dispersal, growth and mortality should occur every year

4.  Ageing -- based on @SchellerMiranda2015

-   follows the same frequency as dispersal, collapsing ages to classes with resolution = to this frequency

5.  Preparation of visual/saved outputs ... (repeat 2-4) ...

#### With disturbances

Note that should a post-disturbance regeneration module be used (e.g., *Biomass_regeneration*), regeneration will occur after the disturbance, but *before* dispersal and background vegetation growth and mortality. Hence, the disturbance should take place either at the very beginning or at the very end of each simulation time step. The general flow of *Biomass_core* processes when disturbances are included (by linking other modules) is:

1.  Preparation of necessary objects for the simulation -- either by accessory prep. data modules, or *Biomass_core* itself (using LANDIS-II test parameters and dummy data.)
2.  Disturbances -- simulated by a disturbance module
3.  Post-disturbance regeneration -- simulated by a regeneration module (*Biomass_regeneration* is an optional download)
4.  Seed dispersal -- see @SchellerDomingo2012 for details
5.  Growth, ageing and mortality -- based on @SchellerMiranda2015
6.  Preparation of visual/saved outputs ... (repeat 2-6) ...

## Usage example

### Load `SpaDES`

```{r load-SpaDES-Biomass-core, eval=FALSE}
library(SpaDES)

## make sure all necessary packages are installed
SpaDES.install::makeSureAllPackagesInstalled(modulePath = "../Biomass_core/")

moduleName <- c("Biomass_core")  
spadesModulesDirectory <- ".." # In general, a module code will be controlled at one level above the source code
```

### Get the module

See [SpaDES-modules repository](https://github.com/PredictiveEcology/SpaDES-modules) to see how to download this and other `SpaDES` modules. Alternatively, it can be forked or cloned from its [GitHub repository](https://github.com/PredictiveEcology/Biomass_core/) directly.

### Setup simulation

```{r module usage example setup -Biomass-core, eval=FALSE}
tempDir <- tempdir()
setPaths(inputPath = file.path(tempDir, "inputs"), 
         cachePath = file.path(tempDir, "cache"), 
         modulePath = spadesModulesDirectory, 
         outputPath = file.path(tempDir, "outputs"))

times <- list(start = 0, end = 30)

studyArea <- Cache(randomStudyArea, size = 1e7) # cache this so it creates a random one only once on a machine

# Pick the species you want to work with – using the naming convention in "Boreal" column of LandR::sppEquivalencies_CA
speciesNameConvention <- "Boreal"
speciesToUse <- c("Pice_Gla", "Popu_Tre", "Pinu_Con")

sppEquiv <- LandR::sppEquivalencies_CA[get(speciesNameConvention) %in% speciesToUse]
# Assign a colour convention for graphics for each species
sppColorVect <- LandR::sppColors(sppEquiv, speciesNameConvention,
                                 newVals = "Mixed", palette = "Set1")

## Usage example
modules <- as.list(moduleName)
objects <- list(studyArea = studyArea, sppEquiv = sppEquiv, sppColorVect = sppColorVect)
paths <- getPaths()

successionTimestep <- 10L

## keep default values for most parameters 
## (omitted from this list)
parameters <- list(
  Biomass_core = list(
    "sppEquivCol" = speciesNameConvention
    , "successionTimestep" = successionTimestep
    , ".plots" = c("screen", "object")
    , ".plotInitialTime" = times$start
    , ".plots" = c("screen", "png")
    , ".saveInitialTime" = times$start
    , ".useCache" = "init"
    , ".useParallel" = FALSE
  )
)

outputs <- data.frame(expand.grid(objectName = "cohortData",
                                  saveTime = unique(seq(times$start, times$end, by = 1)),
                                  eventPriority = 1,
                                  stringsAsFactors = FALSE))

graphics.off()
```

### Run simulation

```{r module usage example run -Biomass-core, eval=FALSE}
mySim <- simInitAndSpades(times = times,
                          params = parameters, 
                          modules = modules, 
                          objects = objects, 
                          paths = paths,
                          outputs = outputs,
                          debug = TRUE)
```

```{r fig-Biomass-coreOutPlots, echo = FALSE, eval = TRUE, fig.show='hold', fig.cap = "(ref:Biomass-core) automatically generates simulation visuals of species dynamics across the landscape in terms of total biomass, number of presences and age and productivity (above), as well as yearly plots of total biomass, productivity, mortality, reproduction and leading species in each pixel (below)."}
knitr::include_graphics(c("figures/Biomass_coreOutPlots1.png", "figures/Biomass_coreOutPlots2.png"))
```

## Appendix

### Tables

| Input order 1 |          |     |            | Input order 2 |          |     |            |
|:--------------|:---------|:----|:-----------|:--------------|:---------|:----|:-----------|
| Community     | Input    | Age | Processing | Community     | Input    | Age | Processing |
|               | order    |     | order      |               | order    |     | order      |
| 1             | abiebals | 20  | poputrem   | 1             | pinustro | 20  | thujocci   |
| 1             | acerrubr | 20  | querelli   | 1             | poputrem | 20  | tiliamer   |
| 1             | acersacc | 20  | pinuresi   | 1             | acerrubr | 20  | querelli   |
| 1             | betualle | 20  | pinustro   | 1             | pinubank | 20  | querrubr   |
| 1             | betupapy | 20  | tiliamer   | 1             | betualle | 20  | betupapy   |
| 1             | fraxamer | 20  | tsugcana   | 1             | piceglau | 20  | fraxamer   |
| 1             | piceglau | 20  | querrubr   | 1             | pinuresi | 20  | tsugcana   |
| 1             | pinubank | 20  | thujocci   | 1             | acersacc | 20  | abiebals   |
| 1             | pinuresi | 20  | acersacc   | 1             | querelli | 20  | acerrubr   |
| 1             | pinustro | 20  | betualle   | 1             | querrubr | 20  | pinubank   |
| 1             | poputrem | 20  | abiebals   | 1             | thujocci | 20  | pinustro   |
| 1             | querelli | 20  | acerrubr   | 1             | tiliamer | 20  | poputrem   |
| 1             | querrubr | 20  | piceglau   | 1             | tsugcana | 20  | pinuresi   |
| 1             | thujocci | 20  | pinubank   | 1             | abiebals | 20  | acersacc   |
| 1             | tiliamer | 20  | betupapy   | 1             | betupapy | 20  | betualle   |
| 1             | tsugcana | 20  | fraxamer   | 1             | fraxamer | 20  | piceglau   |

: (#tab:tableLBSEtest1) Input order and processing order (as determined by LBSE) for the same community used to assess the impact of sequential calculation of the competition index, combined with a lack of explicit species ordering. The input order was the order of species in the initial communities table input file. The processing order was the order used in the simulation, which was obtained from `Landis-log.txt` when `CalibrateMode` was set to 'yes'. Species starting ages are also shown.

| Input order 1 |          |     |            | Input order 2 |          |     |            |
|:--------------|:---------|:----|:-----------|:--------------|:---------|:----|:-----------|
| Community     | Input    | Age | Processing | Community     | Input    | Age | Processing |
|               | order    |     | order      |               | order    |     | order      |
| 1             | abiebals | 1   | poputrem   | 1             | pinustro | 1   | thujocci   |
| 1             | acerrubr | 1   | querelli   | 1             | poputrem | 1   | tiliamer   |
| 1             | acersacc | 1   | pinuresi   | 1             | acerrubr | 1   | querelli   |
| 1             | betualle | 1   | pinustro   | 1             | pinubank | 1   | querrubr   |
| 1             | betupapy | 1   | tiliamer   | 1             | betualle | 1   | betupapy   |
| 1             | fraxamer | 1   | tsugcana   | 1             | piceglau | 1   | fraxamer   |
| 1             | piceglau | 1   | querrubr   | 1             | pinuresi | 1   | tsugcana   |
| 1             | pinubank | 1   | thujocci   | 1             | acersacc | 1   | abiebals   |
| 1             | pinuresi | 1   | acersacc   | 1             | querelli | 1   | acerrubr   |
| 1             | pinustro | 1   | betualle   | 1             | querrubr | 1   | pinubank   |
| 1             | poputrem | 1   | abiebals   | 1             | thujocci | 1   | pinustro   |
| 1             | querelli | 1   | acerrubr   | 1             | tiliamer | 1   | poputrem   |
| 1             | querrubr | 1   | piceglau   | 1             | tsugcana | 1   | pinuresi   |
| 1             | thujocci | 1   | pinubank   | 1             | abiebals | 1   | acersacc   |
| 1             | tiliamer | 1   | betupapy   | 1             | betupapy | 1   | betualle   |
| 1             | tsugcana | 1   | fraxamer   | 1             | fraxamer | 1   | piceglau   |

: (#tab:tableLBSEtest2) Input order and processing order (as determined by LBSE) for the same community used to assess the impact of setting the succession time step to 1, combined with a lack of explicit species ordering. The input order was the order of species in the initial communities table input file. The processing order was the order used in the simulation, which was obtained from `Landis-log.txt` when `CalibrateMode` was set to 'yes'. Species starting ages are also shown.

| Community | Species  | Age 1 | Age 2 | Age 3 | Age 4 | Age 5 | Age 6 | Age 7 |
|:----------|:---------|:------|:------|:------|:------|:------|:------|:------|
| 0         | betupapy | 1     | 37    | 45    | 46    | 85    | NA    | NA    |
| 0         | piceglau | 27    | 73    | 153   | 256   | 270   | NA    | NA    |
| 0         | pinustro | 157   | 159   | 181   | 220   | 223   | 303   | 307   |
| 0         | querrubr | 80    | 102   | 127   | 152   | 206   | 227   | NA    |
| 1         | acerrubr | 3     | 91    | 126   | 145   | NA    | NA    | NA    |
| 1         | acersacc | 138   | 144   | 276   | NA    | NA    | NA    | NA    |
| 1         | betualle | 24    | 106   | 136   | 149   | 279   | NA    | NA    |
| 1         | piceglau | 27    | 67    | 70    | 153   | NA    | NA    | NA    |
| 1         | pinubank | 3     | 10    | 24    | 31    | 71    | NA    | NA    |
| 1         | querelli | 92    | 224   | 234   | NA    | NA    | NA    | NA    |
| 1         | thujocci | 73    | 146   | 262   | NA    | NA    | NA    | NA    |
| 2         | fraxamer | 108   | 118   | 137   | 147   | 204   | NA    | NA    |
| 2         | piceglau | 40    | 128   | 131   | 159   | 174   | NA    | NA    |
| 2         | pinustro | 78    | 156   | 237   | 245   | 270   | NA    | NA    |
| 2         | querelli | 67    | 97    | 186   | 292   | NA    | NA    | NA    |
| 2         | tiliamer | 70    | 103   | 121   | 152   | 178   | 180   | 245   |
| 3         | acerrubr | 5     | 83    | 125   | 126   | 127   | NA    | NA    |
| 3         | pinuresi | 1     | 25    | 42    | 49    | 76    | 79    | 103   |
| 3         | poputrem | 4     | 9     | 62    | NA    | NA    | NA    | NA    |
| 3         | querelli | 101   | 104   | 167   | 226   | NA    | NA    | NA    |
| 3         | tsugcana | 37    | 135   | 197   | 404   | 405   | NA    | NA    |
| 4         | acerrubr | 15    | 29    | 63    | 70    | 105   | 133   | NA    |
| 4         | piceglau | 67    | 132   | 189   | NA    | NA    | NA    | NA    |
| 4         | tsugcana | 21    | 26    | 110   | 146   | 341   | 462   | 463   |
| 5         | acerrubr | 128   | 137   | 145   | 147   | NA    | NA    | NA    |
| 5         | acersacc | 241   | 245   | 261   | 277   | NA    | NA    | NA    |
| 5         | querrubr | 23    | 72    | 120   | 142   | 188   | NA    | NA    |
| 5         | tiliamer | 4     | 68    | 98    | 118   | 139   | 197   | NA    |
| 6         | betualle | 5     | 23    | 31    | 249   | NA    | NA    | NA    |
| 6         | pinubank | 67    | 70    | 89    | NA    | NA    | NA    | NA    |
| 6         | querelli | 194   | 217   | 257   | NA    | NA    | NA    | NA    |

: (#tab:tableLBSEtest3) Randomly generated community combination no. 1 used in the recruitment comparison runs.

| Community | Species  | Age 1 | Age 2 | Age 3 | Age 4 | Age 5 | Age 6 | Age 7 |
|:----------|:---------|:------|:------|:------|:------|:------|:------|:------|
| 0         | acerrubr | 22    | 26    | 30    | 40    | 47    | 145   | 146   |
| 0         | betualle | 23    | 41    | 43    | 120   | 209   | 227   | 270   |
| 0         | fraxamer | 25    | 90    | 119   | 173   | 185   | 282   | NA    |
| 0         | pinuresi | 48    | 53    | 70    | 121   | 157   | NA    | NA    |
| 0         | pinustro | 5     | 82    | 126   | 298   | 352   | NA    | NA    |
| 0         | querrubr | 2     | 30    | 34    | 74    | 77    | 162   | 245   |
| 1         | acerrubr | 2     | 39    | 43    | 84    | 116   | 127   | 143   |
| 1         | pinubank | 34    | 57    | 75    | NA    | NA    | NA    | NA    |
| 1         | querelli | 108   | 202   | 218   | 243   | NA    | NA    | NA    |
| 1         | querrubr | 5     | 117   | 131   | 186   | 189   | 246   | NA    |
| 1         | tiliamer | 10    | 19    | 46    | 80    | 133   | 148   | 231   |
| 1         | tsugcana | 31    | 48    | 190   | 246   | 330   | NA    | NA    |
| 2         | pinubank | 11    | 37    | 38    | 47    | 67    | 93    | NA    |
| 2         | querrubr | 11    | 48    | 57    | 177   | 180   | 228   | 236   |
| 2         | tiliamer | 28    | 42    | 78    | 79    | 223   | 250   | NA    |
| 2         | tsugcana | 140   | 202   | 372   | 381   | 451   | NA    | NA    |
| 3         | acersacc | 48    | 107   | 262   | 265   | NA    | NA    | NA    |
| 3         | betupapy | 4     | 12    | 45    | 65    | 83    | 96    | NA    |
| 3         | poputrem | 13    | 20    | 37    | 75    | 90    | NA    | NA    |
| 3         | querelli | 72    | 90    | 104   | 115   | 116   | 265   | 278   |
| 3         | tiliamer | 20    | 21    | 56    | 98    | 237   | NA    | NA    |
| 3         | tsugcana | 86    | 224   | 425   | 429   | NA    | NA    | NA    |
| 4         | fraxamer | 77    | 133   | 181   | NA    | NA    | NA    | NA    |
| 4         | pinustro | 13    | 37    | 67    | 220   | 287   | 293   | 375   |
| 4         | querrubr | 27    | 48    | 89    | 97    | NA    | NA    | NA    |
| 4         | thujocci | 91    | 244   | 305   | 390   | NA    | NA    | NA    |
| 5         | abiebals | 86    | 95    | 119   | 121   | 127   | 158   | NA    |
| 5         | betualle | 83    | 113   | 136   | 161   | 216   | 231   | NA    |
| 5         | betupapy | 10    | 38    | 64    | NA    | NA    | NA    | NA    |
| 5         | piceglau | 16    | 63    | 70    | 102   | NA    | NA    | NA    |
| 6         | acerrubr | 8     | 34    | 112   | NA    | NA    | NA    | NA    |
| 6         | betupapy | 1     | 31    | 57    | 61    | 74    | 80    | 91    |
| 6         | fraxamer | 63    | 100   | 108   | 140   | 196   | 294   | NA    |
| 6         | pinubank | 15    | 19    | 44    | 47    | 51    | 80    | NA    |
| 6         | thujocci | 78    | 146   | 163   | 213   | 214   | 228   | NA    |
| 6         | tsugcana | 47    | 108   | 387   | 389   | 449   | NA    | NA    |

: (#tab:tableLBSEtest4) Randomly generated community combination no. 2 used in the recruitment comparison runs.

| Community | Species  | Age 1 | Age 2 | Age 3 | Age 4 | Age 5 | Age 6 | Age 7 |
|:----------|:---------|:------|:------|:------|:------|:------|:------|:------|
| 0         | pinubank | 7     | 26    | 32    | 37    | 48    | 85    | 90    |
| 0         | pinuresi | 11    | 103   | 109   | 179   | 188   | 197   | NA    |
| 0         | querrubr | 89    | 139   | 180   | 206   | NA    | NA    | NA    |
| 1         | betupapy | 36    | 39    | 45    | 49    | 66    | 68    | NA    |
| 1         | piceglau | 13    | 165   | 254   | NA    | NA    | NA    | NA    |
| 1         | pinubank | 3     | 19    | 54    | 64    | 76    | NA    | NA    |
| 1         | poputrem | 22    | 59    | 93    | NA    | NA    | NA    | NA    |
| 1         | thujocci | 68    | 98    | 274   | 275   | 363   | 378   | NA    |
| 1         | tiliamer | 13    | 20    | 105   | 124   | 248   | NA    | NA    |
| 1         | tsugcana | 36    | 90    | 142   | NA    | NA    | NA    | NA    |
| 2         | fraxamer | 11    | 241   | 279   | NA    | NA    | NA    | NA    |
| 2         | piceglau | 16    | 42    | 129   | 177   | 200   | 244   | NA    |
| 2         | pinustro | 200   | 342   | 384   | NA    | NA    | NA    | NA    |
| 3         | abiebals | 31    | 57    | 61    | 92    | 108   | 162   | 183   |
| 3         | piceglau | 126   | 255   | 261   | 267   | NA    | NA    | NA    |
| 3         | poputrem | 28    | 41    | 57    | NA    | NA    | NA    | NA    |
| 3         | querrubr | 83    | 91    | 144   | 173   | 184   | 238   | NA    |
| 3         | thujocci | 6     | 66    | 68    | 204   | NA    | NA    | NA    |
| 4         | fraxamer | 12    | 110   | 266   | 270   | NA    | NA    | NA    |
| 4         | pinustro | 174   | 270   | 359   | 379   | NA    | NA    | NA    |
| 4         | poputrem | 4     | 7     | 18    | 24    | 63    | 76    | NA    |
| 4         | tiliamer | 126   | 136   | 197   | NA    | NA    | NA    | NA    |
| 4         | tsugcana | 49    | 91    | 128   | 194   | 411   | 487   | NA    |
| 5         | abiebals | 35    | 53    | 108   | 114   | 147   | 174   | 195   |
| 5         | acerrubr | 1     | 2     | 101   | 145   | NA    | NA    | NA    |
| 5         | pinubank | 14    | 15    | 38    | 40    | 59    | 69    | 83    |
| 6         | acerrubr | 4     | 46    | 117   | NA    | NA    | NA    | NA    |
| 6         | betualle | 36    | 41    | 116   | 213   | 253   | NA    | NA    |
| 6         | betupapy | 4     | 6     | 76    | NA    | NA    | NA    | NA    |
| 6         | pinuresi | 43    | 68    | 85    | 171   | NA    | NA    | NA    |
| 6         | querrubr | 84    | 86    | 113   | 185   | 193   | 223   | 228   |
| 6         | tiliamer | 13    | 106   | 181   | 199   | 246   | NA    | NA    |

: (#tab:tableLBSEtest5) Randomly generated community combination no. 3 used in the recruitment comparison runs.

+----------+-----------+--------------+----------------+------------------+------------------+----------------+-------------+
| Species  | Longevity | Sexualmature | Shadetolerance | Seeddistance_eff | Seeddistance_max | Mortalityshape | Growthcurve |
+==========+===========+==============+================+==================+==================+================+=============+
| abiebals | 200       | 25           | 5              | 30               | 160              | 10             | 0.25        |
+----------+-----------+--------------+----------------+------------------+------------------+----------------+-------------+
| acerrubr | 150       | 10           | 4              | 100              | 200              | 10             | 0.25        |
+----------+-----------+--------------+----------------+------------------+------------------+----------------+-------------+
| acersacc | 300       | 40           | 5              | 100              | 200              | 10             | 0.25        |
+----------+-----------+--------------+----------------+------------------+------------------+----------------+-------------+
| betualle | 300       | 40           | 4              | 100              | 400              | 10             | 0.25        |
+----------+-----------+--------------+----------------+------------------+------------------+----------------+-------------+
| betupapy | 100       | 30           | 2              | 200              | 5000             | 10             | 0.25        |
+----------+-----------+--------------+----------------+------------------+------------------+----------------+-------------+
| fraxamer | 300       | 30           | 4              | 70               | 140              | 10             | 0.25        |
+----------+-----------+--------------+----------------+------------------+------------------+----------------+-------------+
| piceglau | 300       | 25           | 3              | 30               | 200              | 10             | 0.25        |
+----------+-----------+--------------+----------------+------------------+------------------+----------------+-------------+
| pinubank | 100       | 15           | 1              | 20               | 100              | 10             | 0.25        |
+----------+-----------+--------------+----------------+------------------+------------------+----------------+-------------+
| pinuresi | 200       | 35           | 2              | 20               | 275              | 10             | 0.25        |
+----------+-----------+--------------+----------------+------------------+------------------+----------------+-------------+
| pinustro | 400       | 40           | 3              | 60               | 210              | 10             | 0.25        |
+----------+-----------+--------------+----------------+------------------+------------------+----------------+-------------+
| poputrem | 100       | 20           | 1              | 1000             | 5000             | 10             | 0.25        |
+----------+-----------+--------------+----------------+------------------+------------------+----------------+-------------+
| querelli | 300       | 35           | 2              | 30               | 3000             | 10             | 0.25        |
+----------+-----------+--------------+----------------+------------------+------------------+----------------+-------------+
| querrubr | 250       | 25           | 3              | 30               | 3000             | 10             | 0.25        |
+----------+-----------+--------------+----------------+------------------+------------------+----------------+-------------+
| thujocci | 400       | 30           | 2              | 45               | 60               | 10             | 0.25        |
+----------+-----------+--------------+----------------+------------------+------------------+----------------+-------------+
| tiliamer | 250       | 30           | 4              | 30               | 120              | 10             | 0.25        |
+----------+-----------+--------------+----------------+------------------+------------------+----------------+-------------+
| tsugcana | 500       | 30           | 5              | 30               | 100              | 10             | 0.25        |
+----------+-----------+--------------+----------------+------------------+------------------+----------------+-------------+

: (#tab:tableLBSEtest6) Invariant species traits table used in comparison runs.

| Ecolocation | X0  | X1   | X2   | X3  | X4  | X5   |
|:------------|:----|:-----|:-----|:----|:----|:-----|
| All         | 0   | 0.15 | 0.25 | 0.5 | 0.8 | 0.95 |

: (#tab:tableLBSEtest7) Minimum relative biomass table used in comparison runs. X0-5 represent site shade classes from no-shade (0) to maximum shade (5). All ecolocations shared the same values.

| Shadetolerance | 0   | 1   | 2   | 3   | 4   | 5   |
|:---------------|:----|:----|:----|:----|:----|:----|
| 1              | 1   | 0   | 0   | 0   | 0   | 0   |
| 2              | 1   | 1   | 0   | 0   | 0   | 0   |
| 3              | 1   | 1   | 1   | 0   | 0   | 0   |
| 4              | 1   | 1   | 1   | 1   | 0   | 0   |
| 5              | 0   | 0   | 1   | 1   | 1   | 1   |

: (#tab:tableLBSEtest8) Probability of germination for species shade tolerance and shade level combinations (called *sufficient light* table in LBSE and `sufficientLight` input `data.table` in LandR *Biomass_core*) used in comparison runs.

| Ecolocation | Species  | SEP  | maxANPP | maxB  |
|:------------|:---------|:-----|:--------|:------|
| 1           | abiebals | 0.9  | 886     | 26580 |
| 1           | acerrubr | 1    | 1175    | 35250 |
| 1           | acersacc | 0.82 | 1106    | 33180 |
| 1           | betualle | 0.64 | 1202    | 36060 |
| 1           | betupapy | 1    | 1202    | 36060 |
| 1           | fraxamer | 0.18 | 1202    | 36060 |
| 1           | piceglau | 0.58 | 969     | 29070 |
| 1           | pinubank | 1    | 1130    | 33900 |
| 1           | pinuresi | 0.56 | 1017    | 30510 |
| 1           | pinustro | 0.72 | 1090    | 38150 |
| 1           | poputrem | 1    | 1078    | 32340 |
| 1           | querelli | 0.96 | 1096    | 32880 |
| 1           | querrubr | 0.66 | 1017    | 30510 |
| 1           | thujocci | 0.76 | 1090    | 32700 |
| 1           | tiliamer | 0.54 | 1078    | 32340 |
| 1           | tsugcana | 0.22 | 1096    | 32880 |

: (#tab:tableLBSEtest9) Species ecolocation table used in comparison runs. `SEP` stands for species establishment probability, `maxB` for maximum biomass and `maxANPP` for maximum aboveground net primary productivity. Values were held constant throughout the simulation.

### Figures

```{r figLBSEtest1, echo = FALSE, eval = TRUE, out.width = "60%", fig.align = 'center', fig.cap = "Differences in total landscape aboveground biomass when using two different input species orders for the same community. These simulations demonstrate how the sequential calculation of the competition index, combined with a lack of explicit species ordering affect the overall landscape aboveground biomass in time when using different input species orders (see Table \\@ref(tab:tableLBSEtest1)). In order to prevent differences introduced by cohort recruitment, species’ ages at sexual maturity were changed to the species’ longevity values, and the simulation ran for 75 years to prevent any cohorts from reaching sexual maturity. The bottom panel shows the difference between the two simulations in percentage, calculated as $\\frac{Biomass_{order2} - Biomass_{order1}}{Biomass_{order2}} * 100$"}
knitr::include_graphics("figures/figLBSEtest1.png")
```

<br/><br/>

```{r figLBSEtest2, echo = FALSE, eval = TRUE, out.width = "60%", fig.align = 'center', fig.cap = "Differences in the biomasses assigned to new cohorts, summed for each species across pixels, when using two different input species orders for the same community and when the succession time step is 1. These simulations demonstrate how the different summation of total cohort biomass for a succession time step of 1 and the lack of explicit species ordering affect simulation results when changing the species order in the input file (see Table \\@ref(tab:tableLBSEtest2)). Here, initial cohort ages were also set to 1. We show the initial total biomass attributed to each species at the end of year 1."}
knitr::include_graphics("figures/figLBSEtest2.png")
```

<br/><br/>

```{r figLBSEtest3, echo = FALSE, eval = TRUE, out.width = "60%", fig.align = 'center', fig.cap = "Hashing design for (ref:Biomass-core). In the re-coded (ref:Biomass-core), the pixel group map was hashed based on the unique combination of species composition (i.e., community map) and ecolocation map, and associated with a lookup table. The subfigure in the right upper corner was the original design that linked the map to the lookup table by pixel key."}
knitr::include_graphics("figures/figLBSEtest3.png")
```

<br/><br/>

```{r figLBSEtest4, echo = FALSE, eval = TRUE, out.width = "60%", fig.align = 'center', fig.cap = "Visual comparison of simulation outputs for three randomly generated initial communities (left panels) and difference between those outputs (right panels). The % difference between LBSE and (ref:Biomass-core) were calculated as $\\frac{Biomass_{LBSE} - Biomass_{Biomass_core}}{Biomass_{LBSE}} * 100$"}
knitr::include_graphics("figures/figLBSEtest4.png")
```

<br/><br/>

```{r figLBSEtest5, echo = FALSE, eval = TRUE, out.width = "60%", fig.align = 'center', fig.cap = "Simulation efficiencies of LBSE and (ref:Biomass-core) with increasing map size, in terms of a) mean running time across repetitions (left y-axis) and the ratio LBSE to (ref:Biomass-core) running times (right y-axis and blue line), and b) running time scalability as the mean running time per 1000 pixels."}
knitr::include_graphics("figures/figLBSEtest5.png")
```

## References

<!--chapter:end:modules/Biomass_core/Biomass_core2.Rmd-->

# LandR Data Modules

The LandR ecosystem of SpaDES modules has a variety of 'data modules' that are used to obtain and pre-process input data, as well as estimate input parameters required by the core forest landscape simulation module *Biomass_core*. These modules are presented in the next chapters.  

<!--chapter:end:LandR-dataModulesForeword.Rmd-->


# LandR *Biomass_speciesData* Module

<!-- the following are text references used in captions for LaTeX compatibility -->

(ref:Biomass-speciesData) *Biomass_speciesData*

```{r setup-Biomass-speciesData, include=FALSE, eval = TRUE}
knitr::opts_knit$set(root.dir = "modules/Biomass_speciesData")
## set cache.rebuild = TRUE whenever there are changes to the module code/metadata
knitr::opts_chunk$set(echo = TRUE, eval = FALSE, warning = FALSE, 
                      cache = 2, cache.rebuild = TRUE, results = "hold", dpi = 300)

## get citation style
if (!file.exists("citations/ecology-letters.csl")) {
  Require::checkPath("citations", create = TRUE)
  download.file("https://www.zotero.org/styles/ecology-letters?source=1", destfile = "citations/ecology-letters.csl")
}
```

```{r loadPkgs, include = FALSE, cache = FALSE}
Require(c("dplyr", "data.table"), install = TRUE)
```

[![made-with-Markdown](https://img.shields.io/badge/Made%20with-Markdown-1f425f.png)](http://commonmark.org)
[![Generic
badge](https://img.shields.io/badge/Get%20help-Report%20issues-%3CCOLOR%3E.png)](https://github.com/PredictiveEcology/Biomass_speciesData/issues)

<!-- if knitting to pdf remember to add the pandoc_args: ["--extract-media", "."] option to yml in order to get the badge images -->

**This documentation is work in progress. Potential discrepancies and omissions
may exist for the time being. If you find any, do contact us using the link
above\^\^**

#### Authors:

`r paste(as.character(SpaDES.core::moduleMetadata(module = 'Biomass_speciesData', path = '..')$authors), sep = ', ')`
<!-- ideally separate authors with new lines, '\n' not working -->

## Module Overview

### Module summary

This module downloads and pre-process species % cover data layers to be passed
to other LandR data modules (e.g., *Biomass_borealDataPrep*) or to the LandR
forest simulation module *Biomass_core*.

### Module inputs and parameters at a glance

Below are the full list of input objects (Table
\@ref(tab:moduleInputs-Biomass-speciesData)) and parameters (Table
\@ref(tab:moduleParams-Biomass-speciesData)) that *Biomass_speciesData* expects.
Of these, the only input that **must** be provided (i.e., *Biomass_speciesData*
does not have a default for) is `studyAreaLarge`.

Raw data layers downloaded by the module are saved in `dataPath(sim)`, which can
be controlled via `options(reproducible.destinationPath = ...)`.

```{r moduleInputs-Biomass-speciesData, echo = FALSE, eval = TRUE, message = FALSE}
df_inputs <- SpaDES.core::moduleInputs("Biomass_speciesData", "..")[, c(1, 3)]  ## name + desc only
knitr::kable(df_inputs,
             caption = "List of (ref:Biomass-speciesData) input objects and their description.") %>%
  kableExtra::kable_styling(latex_options = "scale_down", full_width = TRUE)
```

```{r moduleParams-Biomass-speciesData, echo = FALSE, eval = TRUE, message = FALSE}
df_params <- SpaDES.core::moduleParams("Biomass_speciesData", "..")[, c(1, 6)] ## name + desc only
knitr::kable(df_params,
             caption = "List of (ref:Biomass-speciesData) parameters and their description.") %>%
  kableExtra::kable_styling(latex_options = "scale_down", full_width = TRUE)
```

### Events

*Biomass_speciesData* only runs two events:

-   Module "initiation" (`init` event), during which all species % cover layers
    are downloaded and processed.
-   Plotting of the processed species cover layers (`initPlot` event).

### Module outputs

The module produces the following outputs (Table
\@ref(tab:moduleOutputs-Biomass-speciesData)):

```{r moduleOutputs-Biomass-speciesData, echo = FALSE, eval = TRUE, message = FALSE}
df_outputs <- SpaDES.core::moduleOutputs("Biomass_speciesData", "..")[, c(1, 3)] ## name + desc only
knitr::kable(df_outputs,
             caption = "List of (ref:Biomass-speciesData) output objects and their description.") %>%
  kableExtra::kable_styling(latex_options = "scale_down", full_width = TRUE)
```

and automatically saves the processed species cover layers in the output path
defined in `getPaths(sim)$outputPath`.

### Links to other modules

Intended to be used with other LandR data modules (e.g.,
*Biomass_borealDataPrep*) that require species cover data and the LandR forest
simulation *Biomass_core* module. You can see all *potential* module linkages
within the LandR ecosystem
[here](https://rpubs.com/PredictiveEcology/LandR_Module_Ecosystem). Select
*Biomass_speciesData* from the drop-down menu to see linkages.

### Getting help

-   <https://github.com/PredictiveEcology/Biomass_speciesData/issues>

## Module manual

### Detailed description

This module accesses and processes species percent cover (% cover) data for the
parametrisation and initialization of LandR *Biomass_core*. This module ensures
1) all data use the same geospatial geometries and 2) that these are correctly
re-projected to studyAreaLarge, and 3) attempts to sequentially fill-in and
replace the lowest quality data with higher quality data when several data
sources are used. It's primary output is a `RasterStack` of species % cover,
with each layer corresponding to a species.

Currently, the module can access the Canadian Forest Inventory forest attributes
kNN dataset [the default; @BeaudoinEtAl2017], the Common Attribute Schema for
Forest Resource Inventories [CASFRI; @Cosco2011] dataset, the Ontario Forest
Resource Inventory (ONFRI), a dataset specific to Alberta compiled by Paul
Pickell, and other Alberta forest inventory datasets. However, **only the NFI
kNN data are freely available** -- access to the other datasets must be granted
by module developers and data owners, and a Google account is required.
Nevertheless, the module is flexible enough that any user can use it to process
additional datasets, provided that an adequate R function is passed to the
module (see `types` parameter details in [Parameters])

When multiple data sources are used, the module will use replace lower quality
data with higher quality data following the order specified by the parameter
`types` (see [Parameters]).

The module can also exclude species % cover layers if they don't have a minimum
% cover value in at least one pixel. This means that the user should still
inspect in how many pixels the species is deemed present, as it is possible that
some data have only a few pixels with high % cover for a given species. In this
case, the user may choose to exclude these species *a posteriori*. The summary
plot automatically shown by *Biomass_speciesData* can help diagnose whether
certain species are present in very few pixels (see Fig.
\@ref(fig:fig-Biomass-speciesDataOutPlots)).

### Initialization, inputs and parameters

*Biomass_speciesData* initializes itself and prepares all inputs provided that
it has internet access to download the raw data layers (or that these layers
have been previously downloaded and stored in the folder specified by
`options("reproducible.destinationPath")`).

The module defaults to processing cover data fo all species listed in the
`Boreal` column of the default `sppEquiv` input `data.table` object, for which
there are available % cover layers in the kNN dataset (Table
\@ref(tab:defaultSppBiomass-speciesData); see `?LandR::sppEquivalencies_CA` for
more information):

```{r defaultSppBiomass-speciesData, echo = FALSE, eval = TRUE, message = FALSE}
data("sppEquivalencies_CA", package = "LandR", envir = environment())
sppEquiv <- as.data.table(sppEquivalencies_CA)

## filter only common species between kNN and default "Boreal" column
## remove empty species names
sppEquiv <- sppEquiv[!(is.na(Boreal) | is.na(KNN) | Boreal == "" | KNN == ""),]
sppEquiv2 <- sppEquiv[, .("Species" = Latin_full, "Generic name" = EN_generic_full)]
sppEquiv2[, Species := sub("(.*)", "\\*\\1\\*", Species)]  ## for italics

knitr::kable(sppEquiv2, 
             caption = "List of species cover data downloaded by default by  (ref:Biomass-speciesData).") %>%
  kableExtra::kable_styling(latex_options = "scale_down", full_width = TRUE)
```

#### Input objects

*Biomass_speciesData* requires the following input data layers

```{r moduleInputs2-Biomass-speciesData, echo = FALSE, eval = TRUE, message = FALSE}
df_inputs <- SpaDES.core::moduleInputs("Biomass_speciesData", "..")
knitr::kable(df_inputs, 
             caption = "List of (ref:Biomass-speciesData) input objects and their description.") %>%
  kableExtra::kable_styling(latex_options = "scale_down", full_width = TRUE)
```

Of the inputs in Table \@ref(tab:moduleInputs2-Biomass-speciesData), the
following are particularly important and deserve special attention:

-   `studyAreaLarge` -- the polygon defining the area for which species cover
    data area desired. It can be larger (but never smaller) that the study area
    used in the simulation of forest dynamics (i.e., `studyArea` object in
    *Biomass_core*).

-   `sppEquiv` -- a table of correspondences between different species naming
    conventions. This table is used across several LandR modules, including
    *Biomass_core*. It is particularly important here because it will determine
    whether and how species (and their cover layers) are merged, if this is
    desired by the user. For instance, if the user wishes to simulate a generic
    *Picea spp.* that includes, *Picea glauca*, *Picea mariana* and *Picea
    engelmannii*, they will need to provide these three species names in the
    data column (e.g., `KNN` if obtaining forest attribute kNN data layers from
    the Canadian Forest Inventory), but the same name (e.g., "Pice_Spp") in the
    coumn chosen for the naming convention used throughout the simulation (the
    `sppEquivCol` parameter); see Table
    \@ref(tab:mergingSpp-Biomass-speciesData) for an example)

```{r mergingSpp-Biomass-speciesData, echo = FALSE, eval = TRUE, message = FALSE}
sppEquiv2 <- sppEquiv[grepl("Abie|Pice|Pinu_Con", Boreal), .(Latin_full, KNN, Boreal)][KNN != "Pice_Spp"]
sppEquiv2[grepl("Pice_", KNN), Boreal := "Pice_Spp"]
sppEquiv2[, "Modelled as" := Latin_full]
sppEquiv2[Boreal == "Pice_Spp", `Modelled as` := "Picea spp."]
setnames(sppEquiv2, "Latin_full", "Species")

sppEquiv2[, `:=`(Species = sub("(.*)", "\\*\\1\\*", Species),
                 `Modelled as` = sub("(.*)", "\\*\\1\\*", `Modelled as`))]  ## for italics

knitr::kable(sppEquiv2, 
             caption = "Example of species merging for simulation. Here the user wants to model _Abies balsamea_, _A. lasiocarpa_ and _Pinus contorta_ as separate species, but all _Picea_ species as a generic _Picea spp._. For this, all six species are identified in the 'KNN' column, so that their % cover layers can be obtained, but in the 'Boreal' column (which defines the naming convention used in the simulation in this example) all _Picea_ species have the same name. (ref:Biomass-speciesData) will merge their % cover data into a single layer by summing their cover per pixel.") %>%
  kableExtra::kable_styling(latex_options = "scale_down", full_width = TRUE)
```

#### Parameters

Table \@ref(tab:moduleParams2-Biomass-speciesData) lists all parameters used in
*Biomass_speciesData* and their detailed information.

```{r moduleParams2-Biomass-speciesData, echo = FALSE, eval = TRUE, message = FALSE}
df_params <- SpaDES.core::moduleParams("Biomass_speciesData", "..")
knitr::kable(df_params,
             caption = "List of (ref:Biomass-speciesData) parameters and their description.") %>%
  kableExtra::kable_styling(latex_options = "scale_down", full_width = TRUE)
```

Of the parameters listed in Table \@ref(tab:moduleParams2-Biomass-speciesData),
the following are particularly important:

-   `coverThresh` -- integer. Defines a minimum % cover value (from 0-100) that
    the species must have in at least one pixel to be considered present in the
    study area, otherwise it is excluded from the final stack of species layers.
    Note that this will affect what species have data for an eventual simulation
    and the user will need to adjust simulation parameters (e.g., species in
    trait tables will need to match the species in the cover layers)
    accordingly.

-   `types` -- character. Which % cover data sources are to be used (see
    [Detailed description]). Several data sources can be passed, in which case
    the module will overlay the lower quality layers with higher quality ones
    **following the order of data sources specified by `types`** -- i.e., if
    `types == c("KNN", "CASFRI", "ForestInventory")`, *KNN* is assumed to be the
    lowest quality data set and *ForestInventory* the highest: values in *KNN*
    layers are replaced with overlapping values from *CASFRI* layers and values
    from *KNN* and *CASFRI* layers are replaced with overlapping values of
    *ForestInventory* layers.

### Simulation flow

The general flow of *Biomass_speciesData* processes is:

1.  Download (if necessary) of and spatial processing of species cover layers
    from the first data source listed in the `types` parameter. Spatial
    processing consists in sub-setting the data to the area defined by
    `studyAreaLarge` and ensuring that the spatial projection and resolution
    match those of `rasterToMatchLarge`. After spatial processing, species
    layers that have no pixels with values \>= to the `coverThresh` parameter
    are excluded.

2.  If more than one data source is listed in `types`, the second set of species
    cover layers is downloaded and processed as above.

3.  The second set of layers is assumed to be the highest quality dataset and
    used to replaced overlapping pixel values on the first (including for
    species whose layers may have been initially excluded after applying the
    `coverThresh` filter).

4.  Steps 2 and 3 are repeated for remaining data sources listed in `types`.

5.  Final layers are saved to disk and plotted. A summary of number of pixels
    with forest cover are calculated (`treed`and `numTreed` output objects; see
    [Module outputs]).

## Usage example

### Load `SpaDES` and other packages.

```{r load-SpaDES-Biomass-speciesData}
if (!require(Require)) {
  install.packages("Require")
  library(Require)
}

Require(c("PredictiveEcology/SpaDES.install",
          "SpaDES", "PredictiveEcology/SpaDES.core@development",
          "PredictiveEcology/LandR"), 
        install_githubArgs = list(dependencies = TRUE))
```

### Get module, necessary packages and set up folder directories

```{r module usage example setup -Biomass-speciesData, eval = FALSE}
tempDir <- tempdir()
spadesModulesDirectory <- file.path(tempDir, "modules")

paths <- list(inputPath = normPath(file.path(tempDir, "inputs")), 
              cachePath = normPath(file.path(tempDir, "cache")), 
              modulePath = normPath(spadesModulesDirectory), 
              outputPath = normPath(file.path(tempDir, "outputs")))

getModule("PredictiveEcology/Biomass_speciesData", modulePath = spadesModulesDirectory, overwrite = TRUE)

## make sure all necessary packages are installed:
makeSureAllPackagesInstalled(spadesModulesDirectory)
```

### Setup simulation

For this demonstration we are using all default parameter values, except
`coverThresh` , which is lowered to 5%. The species layers (the major output of
interest) are saved automatically, so there is no need to tell `spades` what to
save using the `outputs` argument (see `?SpaDES.core::outputs`).

We pass the global parameter `.plotInitialTime = 1` in the `simInitAndSpades`
function to activate plotting.

```{r  module usage example setup2-Biomass-speciesData, eval = FALSE}
# User may want to set some options -- see ?reproducibleOptions 
#    -- e.g., often the path to the 'inputs' folder will be set outside of project by user:
# options(reproducible.inputPaths = "E:/Data/LandR_related/") # to re-use datasets across projects
studyAreaLarge <- Cache(randomStudyArea, size = 1e7,
                        cacheRepo = paths$cachePath) # cache this so it creates a random one only once on a machine

# Pick the species you want to work with -- here we use the naming convention in "Boreal" column of LandR::sppEquivalencies_CA (default)
speciesNameConvention <- "Boreal"
speciesToUse <- c("Pice_Gla", "Popu_Tre", "Pinu_Con")

sppEquiv <- LandR::sppEquivalencies_CA[get(speciesNameConvention) %in% speciesToUse]
# Assign a colour convention for graphics for each species
sppColorVect <- LandR::sppColors(sppEquiv, speciesNameConvention,
                                 newVals = "Mixed", palette = "Set1")

## Usage example
modules <- list("Biomass_speciesData")
objects <- list("studyAreaLarge" = studyAreaLarge,
                "sppEquiv" = sppEquiv,
                "sppColorVect" = sppColorVect)
params <- list("Biomass_speciesData" = list("coverThresh" = 5L))
```

### Run module

Note that because this is a data module (i.e., only attempts to prepare data for
the simulation) we are not iterating it and so both the start and end times are
set to `1` here.

```{r module usage example2-Biomass-speciesData}
opts <- options(reproducible.useCache = TRUE,
                reproducible.inputPaths = paths$inputPath)

mySimOut <- simInitAndSpades(times = list(start = 1, end = 1),
                             modules = modules, 
                             parameters = params,
                             objects = objects, 
                             paths = paths,
                             .plotInitialTime = 1)
options(opts)
```

Here are some of the data retrieved by *Biomass_speciesData* for a randomly
generated study area within Canada.

```{r fig-Biomass-speciesDataOutPlots, eval=TRUE, echo=FALSE, fig.cap = "(ref:Biomass-speciesData) automatically generates a plot of species dominance and number of presences in the study area when `.plotInitialTime=1` is passed as an argument."}
knitr::include_graphics(c("figures/testRunFigure.png"))
```

## References

<!--chapter:end:modules/Biomass_speciesData/Biomass_speciesData2.Rmd-->

# LandR Validation Modules

LandR 'validation modules' differ from 'data modules' in that their objective is not to obtain input data and estimate parameters to run a simulation, but rather to confront simulation outputs against observed data -- even if these modules can potentially obtain and pre-process the validation data.
At the moment, only one validation module is available *Biomass_validationKNN*, but we expect an increment in the number of validation modules as LandR usage expands.

<!--chapter:end:LandR-validModulesForeword.Rmd-->


# LandR *Biomass_validationKNN* Module

<!-- the following are text references used in captions for LaTeX compatibility -->

(ref:Biomass-validationKNN) *Biomass_validationKNN*

```{r setup-Biomass-validationKNN, include=FALSE, eval = TRUE}
knitr::opts_knit$set(root.dir = 'D:/GitHub/LandR-Manual/modules/Biomass_validationKNN')
## set cache.rebuild = TRUE whenever there are changes to the module code/metadata
knitr::opts_chunk$set(echo = TRUE, eval = FALSE, warning = FALSE, 
                      cache = 2, cache.rebuild = FALSE, results = "hold", dpi = 300)

## get citation style
if (!file.exists("citations/ecology-letters.csl")) {
  Require::checkPath("citations", create = TRUE)
  download.file("https://www.zotero.org/styles/ecology-letters?source=1", destfile = "citations/ecology-letters.csl")
}
```

[![made-with-Markdown](https://img.shields.io/badge/Made%20with-Markdown-1f425f.png)](http://commonmark.org)
[![Generic
badge](https://img.shields.io/badge/Get%20help-Report%20issues-%3CCOLOR%3E.png)](https://github.com/PredictiveEcology/Biomass_validationKNN/issues)

<!-- if knitting to pdf remember to add the pandoc_args: ["--extract-media", "."] option to yml in order to get the badge images -->

**This documentation is work in progress. Potential discrepancies and omissions
may exist for the time being. If you find any, do contact us using the link
above\^\^**

#### Authors:

`r paste(as.character(SpaDES.core::moduleMetadata(module = 'Biomass_validationKNN', path = '..')$authors), sep = ', ')`
<!-- ideally separate authors with new lines, '\n' not working -->

## Module Overview

### Module summary

An approach to validating outputs from LandR Biomass - notably the
*Biomass_core* vegetation simulation module - using publicly available data for
Canadian forests. This module produces both visual and statistical validation of
*Biomass_core* outputs that are related to species abundance and
presence/absence in the landscape. To do so, it downloads and prepares all
necessary data (observed and simulated), calculates validation statistics and
produces/saves validation plots.

### Module inputs and parameters at a glance

*Biomass_validationKNN* requires access to outputs of simulations from
*Biomass_core*, and internet access to retrieve the observed kNN datasets used
for validation. Raw data layers downloaded by the module are saved in
`dataPath(sim)`, which can be controlled via
`options(reproducible.destinationPath = ...)`.

We advise future users to run *Biomass_validationKNN* with defaults and inspect
what the objects are like before supplying their own data, or alternative data
URLs. We expect the number of validation modules to increase as other validation
approaches are developed based on project needs.

The module is able to compile all simulation output data provided that the user
supplies the object names and their file paths via the `simulationOutputs` input
object. Alternatively, the user may pass the pre-compiled outputs (namely the
`cohortData` and `pixelGroupMap` objects) via the `allCohortData` and
`pixelGroupMapStk` input objects. See [Input objects] for more detail.

Key parameters are those defining simulation years and replicates,
(`validationYears`, `validationReps`) and plot control (`.plots`). Here's the
full list of parameters:

Below is the full list of input objects (Table
\@ref(tab:moduleInputs-Biomass-validationKNN)) and parameters (Table
\@ref(tab:moduleParams-Biomass-validationKNN)) that *Biomass_validationKNN*
expects. The only input that **must** be provided (i.e., *Biomass_validationKNN*
does not have a default for) is `studyArea`. All other input objects and
parameters have internal defaults (see Tables
\@ref(tab:moduleInputs2-Biomass-validationKNN) and
\@ref(tab:moduleParams2-Biomass-validationKNN). Objects suffixed with `*Start`
correspond to the same objects in the simulation without this suffix (e.g.
`rawBiomassMapStart` is `rawBiomassMap` in the simulation), whereas other
objects like `studyArea` and `rasterToMatch` have the same names in the
simulation and should be exactly the same object.

```{r moduleInputs-Biomass-validationKNN, echo = FALSE, eval = TRUE, message = FALSE}
df_inputs <- SpaDES.core::moduleInputs("Biomass_validationKNN", "..")[, c(1, 3)]  ## name + desc only
knitr::kable(df_inputs,
             caption = "List of (ref:Biomass-validationKNN) input objects and their description.") %>%
  kableExtra::kable_styling(latex_options = "scale_down", full_width = TRUE)
```

```{r moduleParams-Biomass-validationKNN, echo = FALSE, eval = TRUE, message = FALSE}
df_params <- SpaDES.core::moduleParams("Biomass_validationKNN", "..")[, c(1, 6)] ## name + desc only
knitr::kable(df_params,
             caption = "List of (ref:Biomass-validationKNN) parameters and their description.") %>%
  kableExtra::kable_styling(latex_options = "scale_down", full_width = TRUE)
```

### Events

The following events take place during a *Biomass_validationKNN* run. Note that
this module only runs once (in one "time step").

-   Module initiation (`init` event) - prepares both the observed and simulated
    data to be compared

-   Calculation of summary variables for validation (`calculateValidVars` event)

-   Calculation of validation statistics (`validationStats` event)

-   Optional diagnostic plots of biomass and age changes ($\Delta$B,
    $\Delta$Age) in the observed data (`obsDeltaMaps` event).

-   Plotting events:

    -   Plots of landscape-wide (`landscapeWidePlots` event), pixel-level
        (`pixelLevelPlots` events) comparisons of all summary variables

    -   Plots of biomass and age changes ($\Delta$B, $\Delta$Age) in observed
        and simulated data, with respect to the first year. (`deltaBComparisons`
        event)

### Module outputs

The module produces the following outputs (Table
\@ref(tab:moduleOutputs-Biomass-validationKNN)):

```{r moduleOutputs-Biomass-validationKNN, echo = FALSE, eval = TRUE, message = FALSE}
df_outputs <- SpaDES.core::moduleOutputs("Biomass_validationKNN", "..")[, c(1, 3)] ## name + desc only
knitr::kable(df_outputs,
             caption = "List of (ref:Biomass-validationKNN) output objects and their description.") %>%
  kableExtra::kable_styling(latex_options = "scale_down", full_width = TRUE)
```

and saves the validation figures in the output path defined in
`getPaths(sim)$outputPath` (which was defined as `paths$outputPath`). Tables are
not saved unless specified via `spades(outputs = data.frame(...), ...)`. If not
saving objects to disk (such as tables), these can be looked at using, e.g.,
`mySimValidation$logLikelihood`.

### Links to other modules

Intended to be used with *Biomass_core* and any other modules that link to it
and affect cohort biomass (e.g., via `cohortData` table). You can see all
*potential* module linkages within the LandR ecosystem
[here](https://rpubs.com/PredictiveEcology/LandR_Module_Ecosystem). Select
*Biomass_validationKNN* from the drop-down menu to see linkages.

### Getting help

-   <https://github.com/PredictiveEcology/Biomass_validationKNN/issues>

## Module manual

### Detailed description

This module compares simulated outputs of two years (across replicates), with
corresponding years of observed data. It was designed to compare the observed
data for years 2001 (start point for the simulation) and 2011 (i.e., after 10
years of simulation) of the kNN forest layers of the Canadian National Forest
Inventory -- these are currently the only available FAIR datasets [*sensu*
@StallEtAl2019]) on stand biomass and species % cover changes across Canada.
However, the user can supply other sources of observed data, as long as they
have an identical format.

The validation is done both visually (using barplots and boxplots) and using two
statistics: mean absolute deviation of simulated biomass (per species) and the
sum of negative log-likelihoods (SNLL) of predictions with respect to observed
data for species biomass, species presences/absences and changes in biomass
($\Delta$B) - the later is still under development.

This module assumes that the simulation data preparation was carried out by
*Biomass_borealDataPrep*, and so, to ensure that the comparison and the
simulated datasets are built with the same assumptions, the data treatment steps
in *Biomass_borealDataPrep* are repeated here. The module may also excludes
disturbed pixels coded in `rstLCCChange` and fire perimeter data
(`firePerimeters`). If this is not intended, pass a `rstLCCChange` with `NA`'s
only and/or an empty `firePerimeters` `sf` object. *Biomass_validationKNN* then
compares simulated species biomass, presences, dominance, and changes in biomass
against observed data available for the starting conditions (2011 by default)
and a second time point (e.g. 2011, or after 10 years of simulation). To do so,
for each year and replicate, and for both the simulated and observed data, the
module calculates:

-   species relative abundances at the pixel- and landscape-level (across all
    pixels)

-   species presences and dominance at the landscape level

-   changes in species biomass ($\Delta$B) at the pixel- and landscape-level for
    both the simulated and observed data. Biomass units respect those used in
    *Biomass_core* ($g/m^2$).

Pixel-level relative abundances are calculated as the species biomass (summed
across cohorts) divided by the total pixel biomass (summed across cohorts and
species), while landscape-wide relative abundances are calculated as the sum of
a species biomass across all pixels divided by the sum of total biomass across
all pixels. Species presences are calculated as the number of pixels where a
given species is present, and species dominance is calculated as the number of
pixels where a species has the highest relative biomass in a given pixel. Pixels
where two or more species share the highest biomass value are classified as
'mixed forest', and pixels without any biomass are classified as 'no veg.'.
Finally, ($\Delta$B) is calculated per species as the final biomass (e.g., year
2011) minus the initial biomass (e.g., year 2001), either at the pixel- or
landscape-level. All calculations were done per replicate.

### Validation approaches

#### Visual validation

The module plots the above metrics as barplots showing landscape-level values
(averaged across replicates for the simulated data) or boxplots showing
pixel-level values. Plotting can be live and/or in the form of exported images
(or both turned off completely).

#### Mean absolute deviation

Mean absolute deviance (MAD) values are calculated on landscape- and pixel-level
species relative abundances and $\Delta$B, and landscape-level species presences
and dominance, per replicate and year (except for $\Delta$B, which is integrated
across years). Output tables with MAD values are exported as `landscapeMAD` and
`pixelMAD`, and the module also produces visual inspection of these values as
dot-and-whisker plots.

#### Sum of negative log-likelihood (SNLL)

To provide a measure of overall goodness of fit of the simulation model, given a
given set of starting conditions and simulation mechanisms (i.e., the
combination of inputs to *Biomass_core* but also other modules that may be
associated in affecting vegetation dynamics), *Biomass_validationKNN* estimates
sum of negative log-likelihoods (SNLL) of simulated species biomasses, $\Delta$B
(both at the landscape and pixel-level), and species presences (at the
landscape-level), with respect to their observed counterparts. More precisely,
let $\ell$ be the log-likelihood function denoting the probability of observing
$x$ of $X$ (a random variable following a continuous probability distribution
$f(x)$), given a parameter $\theta$:

```{=tex}
\begin{equation}
  \ell(\theta \mid x) = f(x)
  (\#eq:loglik)
\end{equation}
```
In our case, $\theta$ is equivalent to the model's starting conditions and
structure, $X$ is the observed data with $x$ being the simulated values, and
$f(x)$ the continuous probability distribution of $X$. For each variable that we
wanted to evaluate and for each simulation replicate, Equation \@ref(eq:loglik)
is applied to calculate the SNLL estimated for each value of $x$ at the pixel or
landscape-level, $i$:

```{=tex}
\begin{equation}
  -\sum_{i = 1}^{N} \ell(\theta \mid x_{i})
  (\#eq:negsumloglik)
\end{equation}
```
where $N$ is equal to total number of pixels. At the landscape scale $N = 1$.

For species biomass and species presences, we draw the probability of observing
$x_{i}$ (a vector of species biomasses/presences in pixel/landscape $i$) from a
multinomial density distribution
($f(x_{i}) = {\sf Multi}(n_{i}, \mathrm{p}_{i})$), where
$n_{i} = \sum_{j = 1}^{K} X_{i,j}$ ($X$ being the observed values of biomass of
$j = 1, ..., K$ species in a pixel/landscape $i$) and $\mathrm{p_{i}}$ is the
vector of simulated values $x_{i,j}$.

**The computation of SNLL for** $\Delta$B is still under development. We have
implemented the following, approach: For $\Delta$B, we draw the probability of
observing $x_{i,j}$ (the simulated $\Delta$B of $j = 1, ..., K$ species in a
pixel/landscape $i$) from a multivariate Gaussian distribution,
$f(x_{i}) = \mathcal {N}(\mu_{i}, \mathrm{M}_{i})$, where $\mu_{i}$ is the
vector of observed mean $\Delta$B for each species $j = 1, ..., K$, and
$\mathrm{M}$ is the observed $K * K$ variance-covariance matrix of species
$\Delta$B. Unfortunately this is presenting problems, due to $\mathrm{M}$ not
being strictly positive definite.

After calculating SNLL across pixels (or for a landscape), values are averaged
across replicates for an overall model estimate and exported in the
`logLikelihood` table.

We refer to the Wikipedia pages on the [multinomial
distribution](https://en.wikipedia.org/wiki/Multinomial_distribution) and on the
[multivariate Gaussian
distribution](https://en.wikipedia.org/wiki/Multivariate_normal_distribution#Density_function)
for a good summary of these two distributions and their use in SNLL estimation.

### Initialization, inputs and parameters

*Biomass_validationKNN* initializes itself and prepares all inputs provided that
it has access to outputs of simulations from *Biomass_core*, and internet access
to retrieve the observed kNN datasets used for validation. Future users should
run *Biomass_validationKNN* with defaults and inspect what the objects are like
before supplying their own data, or alternative data URLs. Alternatively, users
may develop their own validation modules using *Biomass_validationKNN* as a
template.

#### Input objects

*Biomass_validationKNN* requires the following input data layers: land-cover
change (change type and year), fire perimeters, % species cover, stand age and
stand biomass. By default, the module will take these from National Forest
Inventory kNN layers for years 2001 and 2011. We recommend that the user
supplies layers used to initialise the simulation as the starting input layers
(2001 if that is the starting point) to guarantee that they match. Table
\@ref(tab:moduleInputs2-Biomass-validationKNN) shows the full list of input
objects used by the module.

```{r moduleInputs2-Biomass-validationKNN, echo = FALSE, eval = TRUE, message = FALSE}
df_inputs <- SpaDES.core::moduleInputs("Biomass_validationKNN", "..")
knitr::kable(df_inputs, 
             caption = "List of (ref:Biomass-validationKNN) input objects and their description.") %>%
  kableExtra::kable_styling(latex_options = "scale_down", full_width = TRUE)
```

Of the inputs in Table \@ref(tab:moduleInputs2-Biomass-validationKNN), the
following are particularly important and deserve special attention:

-   **Spatial layers**

    -   `biomassMap` -- a map of simulated stand biomass (in $g/m^2$ ) filtered
        for the pixels where cohort dynamics were simulated. This corresponds to
        the `sim$biomassMap` object produced by *Biomass_borealDataPrep* or to
        the `sim$simulatedBiomassMap` produced by *Biomass_core*.

    -   `firePerimeters` -- a fire perimeters polygon map that should be used to
        exclude recently burned pixels from the analysis. If this is not desired
        the user needs to provide an empty `sf` object (e.g.,
        `sf::st_polygon()`) .

    -   `rawBiomassMapStart` -- raw biomass data used to initialize and
        parametrize `Biomass_core`. By default, the module uses the stand
        biomass map from KNN for the year 2001. The user must make sure this
        appropriate for their use case, or else supply the correct raster layer.

    -   `rawBiomassMapEnd` -- raw biomass data used to validate the model after
        several simualtion years. By default, the module uses the stand biomass
        map from KNN for the year 2011, which is compared with the 10th year of
        a simulation initialised using the KNN 2001 data. The user must make
        sure this appropriate for their use case, or else supply the correct
        raster layer.

    -   `rstLCChange` -- a binary raster layer with disturbed pixels that should
        be removed from the analyses. Can be combined with `rstLCChangeYr` to
        filter pixels disturbed in a given time period defined by
        `P(sim)$LCChangeYr`. Defaults to [Canada's forest change national map
        between 1985-2011
        (CFS)](https://opendata.nfis.org/downloads/forest_change/C2C_change_type_1985_2011.zip).

    -   `rstLCChangeYr` -- a raster layer with year of disturbance. This is an
        optional layer that can be combined with `rstLCChange` and
        `P(sim)$LCChangeYr` to filter disturbed pixels by year of disturbance.
        Not used by default. Defaults to [Canada's forest change year national
        map between 1985-2011
        (CFS)](https://opendata.nfis.org/downloads/forest_change/C2C_change_year_1985_2011.zip).

    -   `speciesLayersStart` -- same as `rawBiomassMapStart`, but with respect
        to species % cover data.

    -   `speciesLayersEnd` -- same as `rawBiomassMapEnd`, but with respect to
        species % cover data.

    -   `studyArea` -- shapefile. A `SpatialPolygonsDataFrame` with a single
        polygon determining the where the simulation will take place. This is
        the only input object that **must be supplied by the user**.

-   **Simulation-related objects**

    -   `allCohortData` -- OPTIONAL. A `data.table` containing all `cohortData`
        objects relevant for the validation (e.g., as many `cohortData` objects
        as simulation replicates times 2, for the beginning and end year). If
        not supplied, *Biomass_validationKNN* attempts to produce this object
        using the `cohortData` object file listed in `simulationOutputs` .
        Hence, the user must either supply **both** `allCohortData` and
        `pixelGroupMapStk` **or** `simulationOutputs.`

    -   `pixelGroupMapStk` -- OPTIONAL. As `allCohortData` but with respect to
        `pixelGroupMap` objects.

    -   `simulationOutputs` -- OPTIONAL. A `data.frame` that has the same
        structure as the `data.frame`'s specifying outputs to be saved in
        `spades(…, outputs = data.frame(…))`. We advise passing the same
        `data.frame` that was supplied to `spades` during the simulation call,
        but filtered by the relevant `cohortData` and `pixelGroupMap` objects
        and, potentially, with file paths corrected to match the current working
        directory (see [Usage example]). Only used if `allCohortData` and
        `pixelGroupMapStk` are not supplied.

    -   `pixelGroupMap` -- a raster layer with *pixelGroup* IDs per pixel.
        Pixels are always grouped based on identical *ecoregionGroup*,
        *speciesCode*, *age* and *B* composition, even if the user supplies
        other initial groupings (e.g., this is possible in the
        *Biomass_borealDataPrep* data module).

#### Parameters

Table \@ref(tab:moduleParams2-Biomass-validationKNN) lists all parameters used
in *Biomass_validationKNN* and their detailed information.

```{r moduleParams2-Biomass-validationKNN, echo = FALSE, eval = TRUE, message = FALSE}
df_params <- SpaDES.core::moduleParams("Biomass_validationKNN", "..")
knitr::kable(df_params,
             caption = "List of (ref:Biomass-validationKNN) parameters and their description.") %>%
  kableExtra::kable_styling(latex_options = "scale_down", full_width = TRUE)
```

Of the parameters listed in Table
\@ref(tab:moduleParams2-Biomass-validationKNN), the following are particularly
important:

-   `LCChangeYr` -- integer. Optional parameter defining the years of
    disturbance that should be filtered out of the analysis using the
    `rstLCChangeYr` layer. This parameter is set to `NULL` by default, meaning
    that `rstLCChangeYr` will not be used.

-   `sppEquivCol` -- character. the column name in `specieEquivalency`
    data.table that defines the naming convention to use throughout the
    simulation. The user needs to make sure the is

-   `validationReps` -- integer. which simulation replicates should be used for
    the validation.

-   `validationYears` -- integer. What simulation years should be used for the
    validation - the year number needs to match the observed data year. For
    instance, if the first observed data year is 2001, that must be the first
    simulation year.

### Simulation flow

The general flow of *Biomass_validationKNN* processes is:

1.  Preparation of all necessary objects, namely obtaining the observed data
    layers from online repositories (or if available stored local copies) and
    the compiling simulated data if the user has not done so previously (see
    [Input objects]).

2.  Calculation of summary variables for validation, namely:

    -   relative biomass per species per pixel and across the landscape (per
        year and per replicate)

    -   changes in species biomass per pixel and across the landscape (per
        replicate), with respect to the first year.

    -   species dominance across the landscape

    -   species presences across the landscape

3.  Calculation of validation statistics, namely mean absolute deviations (MAD)
    and sum of negative log-likelihoods (SNLL).

4.  Assessment of the relationship between observed $\Delta$B and observed
    $\Delta$Age -- this is an optional visual diagnostic of the observed data
    that produces scatterplots of $\Delta$B \~ $\Delta$Age of three types:

    -   With raw observed values of $\Delta$B and $\Delta$Age

    -   With $\Delta$B and $\Delta$Age calculated on observed data *after*
        pre-processing (i.e., the data clean-steps done in
        `Biomass_borealDataPrep`, which are also done to the observed data
        before validation)

    -   With the data shown in 2) above, but filtered by pixels where there was
        only a stand age increment corresponding to the number of years of
        between the two validation time points. This is not necessarily a
        *correct* filter, as stands may have suffered an age reduction due to
        the loss of old cohorts from background mortality (i.e., not coming from
        disturbances. However, if using the default input datasets, it is
        unlikely that this is a widespread phenomenon in only 10 years. We
        remind the user that disturbed pixels should be removed from the
        analyses when validating succession dynamics in the absence of
        disturbance - the default option.

5.  Plots:

    -   Barplots of landscape-wide and pixel-level comparisons between observed
        and simulated data, with respect to relative biomass, dominance and
        presences.

    -   Boxplots of biomass changes ($\Delta$B) in observed and simulated data,
        with respect to the first year.

    -   Maps of biomass and age changes ($\Delta$B, $\Delta$Age) with respect to
        the first year, in observed and simulated data.

All module default outputs are in the form of plots, but the user can chose to
save any objects (see Table \@ref(tab:moduleOutputs-Biomass-validationKNN)).

## Usage example

### Load `SpaDES` and other packages.

```{r load-SpaDES-Biomass-validationKNN, eval=FALSE}
library(SpaDES)
library(SpaDES.install)
library(SpaDES.experiment)
library(future)
```

### Get the modules

Because *Biomass_validationKNN* is meant to validate simulation outputs against
observed data, we need to first run a simulation of forest dynamics with
*Biomass_core*. To do that we get both modules' code from the PredictiveEcology
GitHub repository. Notice that we are placing all module code, inputs and
outputs in temporary directories.

```{r module usage example setup -Biomass-validationKNN, eval = FALSE}
tempDir <- tempdir()
spadesModulesDirectory <- file.path(tempDir, "modules")
paths <- list(inputPath = file.path(tempDir, "inputs"), 
                 cachePath = file.path(tempDir, "cache"), 
                 modulePath = spadesModulesDirectory, 
                 outputPath = file.path(tempDir, "outputs"))

getModule("PredictiveEcology/Biomass_core", modulePath = spadesModulesDirectory, overwrite = TRUE)
getModule("PredictiveEcology/Biomass_validationKNN", modulePath = spadesModulesDirectory, overwrite = TRUE)

## by default the repository branch name is appended to the module folder name.
## so we change the folder name to remove the "-master" suffix.
file.rename(c(file.path(spadesModulesDirectory, "Biomass_core-master"),
              file.path(spadesModulesDirectory, "Biomass_validationKNN-master")),
            c(file.path(spadesModulesDirectory, "Biomass_core"),
              file.path(spadesModulesDirectory, "Biomass_validationKNN")))
```

### Setup simulation

```{r  module usage example setup2 -Biomass-validationKNN, eval = FALSE}
times <- list(start = 2001, end = 2011)

studyArea <- Cache(randomStudyArea, size = 1e7) # cache this so it creates a random one only once on a machine

# Pick the species you want to work with -- using the naming convention in "Boreal" column of LandR::sppEquivalencies_CA
speciesNameConvention <- "Boreal"
speciesToUse <- c("Pice_Gla", "Popu_Tre", "Pinu_Con")

sppEquiv <- LandR::sppEquivalencies_CA[get(speciesNameConvention) %in% speciesToUse]
# Assign a colour convention for graphics for each species
sppColorVect <- LandR::sppColors(sppEquiv, speciesNameConvention,
                                 newVals = "Mixed", palette = "Set1")

## Usage example
modules <- as.list("Biomass_core")
objects <- list(studyArea = studyArea, sppEquiv = sppEquiv, sppColorVect = sppColorVect)

successionTimestep <- 20L

## keep default values for most parameters 
## (ommitted from this list)
parameters <- list(
  Biomass_core = list(
    "sppEquivCol" = speciesNameConvention
    , "successionTimestep" = successionTimestep
    , ".plotInitialTime" = times$start
    , ".plotInterval" = 1L
    , ".plots" = "png"
    , ".saveInitialTime" = times$start
    , ".useCache" = "init"
    , ".useParallel" = FALSE
  )
)

outputs <- data.frame(expand.grid(objectName = "cohortData",
                                  saveTime = unique(seq(times$start, times$end, by = 1)),
                                  eventPriority = 1,
                                  stringsAsFactors = FALSE))
outputs <- rbind(outputs, data.frame(objectName = "pixelGroupMap",
                                     saveTime = unique(seq(times$start, times$end, by = 1)),
                                     eventPriority = 1))
```

### Run simulation

Here we run a simulation with three replicates using the `experiment2` function
of the `SpaDES.experiment` R package [@McIntireChubaty2021], which builds a
folder structure where simulation outputs are conveniently organised.

```{r module usage example2 -Biomass-validationKNN, eval=FALSE}
graphics.off()
mySimInit <- simInit(times = times,
                     params = parameters, 
                     modules = modules, 
                     objects = objects, 
                     paths = paths,
                     outputs = outputs)

plan(sequential)
mySimExperiment <- experiment2(
  sim1 = mySimInit,
  clearSimEnv = FALSE,
  replicates = 3)
```

### Validate simulation outputs with *Biomass_validationKNN*

Note that because we ran *Biomass_core* by itself using theoretical input data,
we can expect the validation to reveal that the module didn't do a great job at
reproducing observed patterns.

```{r module usage example validation,  eval=FALSE}
simulationOutputs <- lapply(mySimExperiment, FUN = function(x, localSimPaths) {
  oldPath <- dirname(outputPath(x)) ## exclude sim*_rep* folder
  DT <- as.data.table(outputs(x))
  DT[, file := sub(oldPath, localSimPaths$outputPath, file)]
  DT
}, localSimPaths = as.list(normPath(paths)))
simulationOutputs <- rbindlist(simulationOutputs)

validationPaths <- as.list(normPath(paths))
validationPaths$outputPath <- file.path(validationPaths$outputPath, "validation")

validationTimes <- list(start = 1, end = 1)
validationParams <- list(
  Biomass_validationKNN = list(
    "sppEquivCol" = params(mySimInit)$Biomass_core$sppEquivCol
    , "validationReps" = as.integer(1:3)  ## or length of simLists
    , "validationYears" = as.integer(c(2001, 2011))
    , ".plots" = c("png")
  )
)

## make an empty fire polygon object to bypass removing fire-disturbed pixels
noFires <- sf::st_polygon()
validationObjects <- list(
  "biomassMap" = mySimExperiment$sim1_rep1$biomassMap
  , "firePerimeters" = noFires
  , "rasterToMatch" = mySimExperiment$sim1_rep1$rasterToMatch
  , "rawBiomassMapStart" = mySimExperiment$sim1_rep1$biomassMap
  , "simulationOutputs" = simulationOutputs
  , "speciesLayersStart" = mySimExperiment$sim1_rep1$speciesLayers
  , "sppColorVect" = mySimExperiment$sim1_rep1$sppColorVect
  , "sppEquiv" = mySimExperiment$sim1_rep1$sppEquiv
  , "studyArea" = mySimExperiment$sim1_rep1$studyArea
)

mySimValidation <- simInitAndSpades(times = validationTimes
                                    , params = validationParams
                                    , modules = "Biomass_validationKNN"
                                    , objects = validationObjects
                                    , paths = validationPaths
                                    , .studyAreaName = SAname)
```

Here are some of the output figures automatically produced by
*Biomass_validationKNN*

```{r fig-Biomass-validationKNNOutPlots, echo = FALSE, eval = TRUE, fig.show='hold', out.width = "50%", fig.cap = "(ref:Biomass-validationKNN) automatically generates plots showing a visual comparison between simulated and observed species presences (right) across the landscape, and relative species biomass per pixel (left)."}
knitr::include_graphics(c("figures/LandscapeComparisons_PresAbs.png", "figures/PixelComparisons_relB.png"))
```

```{r fig-Biomass-validationKNNOutPlots2, echo = FALSE, eval = TRUE, fig.show='hold', fig.cap = "A plot of landscape-wide mean absolute deviations (MAD) from (top to bottom) observed mean relative abundance, no. of presences, no. of pixels where the species is dominant and $\\Delta$B."}
knitr::include_graphics(c("figures/landscapeMAD.png"))
```

```{r fig-Biomass-validationKNNOutPlots3, echo = FALSE, eval = TRUE, fig.show='hold', fig.cap = "Diagnostic plot of observed changes in biomass and age $\\Delta$B and $\\Delta$Age, respectively)."}
knitr::include_graphics(c("figures/observedDeltaBDeltaAge.png"))
```

## References

<!--chapter:end:modules/Biomass_validationKNN/Biomass_validationKNN2.Rmd-->

